<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-eval' 'unsafe-inline' data: https:; img-src 'self' data: https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https:; object-src 'self'"/><meta name="viewport" content="width=device-width,initial-scale=1"><title>GitLab CI push output to GitHub</title><meta name="msvalidate.01" content="009F12474AB330989749B979B5868A7F"/><meta name="google-site-verification" content="in8GfCIv-CYlwD5AxO0jVMlrUy1s42a_-cxlOWdv4U0"/><meta name="yandex-verification" content="c29e9c1084b24e1d"/><meta name="description" content="Utilise GitLab CI runner to build and publish static website to GitLab and GitHub pages."/><meta name="author" content="Leow Kah Man"/><link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192"/><link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32"/><link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16"/><link rel="canonical" href="https://www.leowkahman.com/2017/09/09/gitlab-ci-push-output-to-github/"><link href="" rel="alternate" type="application/rss+xml" title="Leow Kah Man - Tech Blog"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" integrity="sha256-Zd1icfZ72UBmsId/mUcagrmN7IN5Qkrvh75ICHIQVTk=" crossorigin="anonymous"/><link rel="stylesheet" href="/css/custom.css?v=1.0.0"/><style id="antiClickjack">body{display:none!important}</style><script>if(self===top){var antiClickjack=document.getElementById("antiClickjack");antiClickjack.parentNode.removeChild(antiClickjack)}else top.location=self.location</script><script>function redirectToCorrectDomainIfRequired(){for(var o=["www.leowkahman.com","localhost"],e=0;e<o.length;e++)if(window.location.hostname==o[e])return;window.location="https://www.leowkahman.com"+window.location.pathname}redirectToCorrectDomainIfRequired()</script></head><body><nav class="navbar navbar-default navbar-static-top"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">Leow Kah Man - Tech Blog</a></div><div id="navbar" class="navbar-collapse collapse"><ul class="nav navbar-nav"></ul><ul class="nav navbar-nav navbar-right"><li><a href="/about/">About</a></li><li><a href="/contact/">Contact</a></li></ul></div></div></nav><div class="container"><div class="row"><div class="col-sm-12"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="7600784826" data-ad-format="auto"></ins></div></div><div class="row"><div class="col-sm-8 blog-main"><div class="row"><div class="blog-main blog-post"><h1 class="blog-post-title">GitLab CI push output to GitHub</h1><p class="blog-post-meta"><i class="fa fa-calendar"></i> Published: 9 September 2017 &nbsp;|&nbsp; <i class="fa fa-folder"></i> <a href="https://www.leowkahman.com/categories/web">Web</a></p><ul class="list-inline share" style="margin-top:15px;margin-left:0"><li class="facebook-share"><a target="_blank" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.leowkahman.com%2f2017%2f09%2f09%2fgitlab-ci-push-output-to-github%2f"><i class="fa fa-facebook fa-lg"></i> Facebook</a></li><li class="googleplus-share"><a target="_blank" href="https://plus.google.com/share?url=https%3a%2f%2fwww.leowkahman.com%2f2017%2f09%2f09%2fgitlab-ci-push-output-to-github%2f"><i class="fa fa-google-plus fa-lg"></i> Google+</a></li><li class="twitter-share"><a target="_blank" href="https://twitter.com/share?url=https%3a%2f%2fwww.leowkahman.com%2f2017%2f09%2f09%2fgitlab-ci-push-output-to-github%2f&amp;text=GitLab%20CI%20push%20output%20to%20GitHub"><i class="fa fa-twitter fa-lg"></i> Twitter</a></li><li class="reddit-share"><a target="_blank" href="http://reddit.com/submit?url=https%3a%2f%2fwww.leowkahman.com%2f2017%2f09%2f09%2fgitlab-ci-push-output-to-github%2f&amp;title=GitLab%20CI%20push%20output%20to%20GitHub"><i class="fa fa-reddit fa-lg"></i> Reddit</a></li><li class="linkedin-share"><a target="_blank" href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.leowkahman.com%2f2017%2f09%2f09%2fgitlab-ci-push-output-to-github%2f"><i class="fa fa-linkedin fa-lg"></i> LinkedIn</a></li></ul><p>Utilise GitLab CI runner to build and publish static website to GitLab and GitHub pages. By having mirrored copies, it is possible to switch DNS records to point to either for high availability reasons.</p><p></p><h2 id="motivation">Motivation</h2><p>As with most free service providers, GitLab Pages and GitHub Pages do not offer SLA. One can argue that they have historically been averaging a very respectable uptime but past performance if used as an indication should be taken with a grain of salt. That being said, it is of course in their interest to ensure high uptime and performance for their reputation.</p><p>As a user of such service, I need high availability. One way to do this is by having mirrored copies so that I could switch DNS settings at any time. Given that I use <a href="https://support.cloudflare.com/hc/en-us/articles/200169626-What-subdomains-are-appropriate-for-orange-gray-clouds-">CloudFlare with orange cloud</a>, <a href="https://www.reddit.com/r/webdev/comments/3icvv5/why_are_cloudflares_dns_changes_almost_instant/">traffic gets diverted to new destination almost instantly</a>.</p><p>I will be sharing how to setup GitLab CI to build and publish to GitLab as well as GitHub. You can take it further by configuring 3rd party DNS traffic manager to monitor and automatically failover. This is beyond scope of this post.</p><h2 id="pre-requisites">Pre-requisites</h2><p>Basic knowledge on how to use Git. Repositories already exist in both GitLab and GitHub. For the latter, you can start with an empty repository.</p><p>Please read my earlier post <a href="/2017/08/15/hugo-static-site-generator-with-ci-deployment-using-gitlab/">Hugo Static Site Generator with CI Deployment using GitLab</a>. The bits below is an addition over this.</p><h2 id="the-solution">The solution</h2><p>Below is my new GitLab CI YAML script:</p><pre><code class="language-yaml">image: node:6.11.2-alpine
before_script:
  - apk update &amp;&amp; apk add openssl ca-certificates git
  - npm install
  - PATH=$(npm bin):$PATH
  - hugo version
pages:
  script:
  - npm run build
  - git clone --depth 1 https://&lt;username&gt;:$GITHUB_ACCESS_TOKEN@github.com/&lt;username&gt;/&lt;username&gt;.github.io.git
  - mkdir &lt;username&gt;.github.io.new
  - cp -a &lt;username&gt;.github.io/.git &lt;username&gt;.github.io.new/.git
  - cp -a public/* &lt;username&gt;.github.io.new
  - cd &lt;username&gt;.github.io.new
  - git config user.email &quot;&lt;GitHub email address&gt;&quot;
  - git config --global user.name &quot;&lt;Your name&gt;&quot;
  - git add -A
  - git diff-index --quiet HEAD || git commit -m &quot;$CI_SERVER_NAME $CI_PIPELINE_ID&quot;
  - git push
  artifacts:
    paths:
    - public
  only:
  - master
</code></pre><p>The key additions are:</p><ol><li><code>apk add git</code> - Installation of Git since the Docker image used does not have it.</li><li><code>git clone --depth 1</code> - Clones only the latest revision of repository from GitHub. The clone is downloaded to <code>&lt;username&gt;.github.io</code> directory.</li><li><code>$GITHUB_ACCESS_TOKEN</code> is a <a href="https://docs.gitlab.com/ee/ci/variables/#secret-variables">GitLab secret variable</a> which stores the <a href="https://github.com/settings/tokens">GitHub personal access token</a>. When creating the token at GitHub, name the token <em>GitLab</em> or whatever you prefer then assign it with <code>public_repo</code> access.<br/>Then head over to GitLab <code>Settings &gt; Pipelines</code> and define a secret variable named <code>GITHUB_ACCESS_TOKEN</code> and paste the GitHub personal access token into the Value field.</li><li><code>mkdir &lt;username&gt;.github.io.new</code> - A temporary folder; to be published from.</li><li><code>cp -a &lt;username&gt;.github.io/.git &lt;username&gt;.github.io.new/.git</code> - Copy the <code>.git</code> folder to the temporary directory. Not interested in the other stuff in the cloned directory.</li><li><code>cp -a public/* &lt;username&gt;.github.io.new</code> - Hugo static site generator outputs to <code>public</code> directory by default. Copy the output directory to the temporary directory.</li><li><code>cd &lt;username&gt;.github.io.new</code> - Change the current directory to the temporary directory as subsequent commands are against this.</li><li><code>git config user.email &quot;&lt;GitHub email address&gt;&quot;</code> - Put your GitHub email address here.</li><li><code>git config --global user.name &quot;&lt;Your name&gt;&quot;</code> - Put your name here.</li><li><code>git add -A</code> - Stage all (new, modified, and deleted) changes.</li><li><code>git diff-index --quiet HEAD || git commit -m &quot;$CI_SERVER_NAME $CI_PIPELINE_ID&quot;</code> - Commits changes. There is a chance for Git to detect no changes to <code>public</code> directory. i.e. when updating <code>.gitlab-ci.yml</code> which sits outside the <code>public</code> directory. When committing, set commit message to GitLab server name and pipeline ID.</li><li><code>git push</code> - Pushes commited changes to GitHub.</li></ol><p>To test this out, simply Git push to GitLab and wait for the CI runner to do its thing.</p><h2 id="troubleshooting">Troubleshooting</h2><h3 id="github-cname-file">GitHub CNAME file</h3><p>In order for GitHub to serve content on your custom domain, a file named <a href="https://help.github.com/articles/troubleshooting-custom-domains/">CNAME</a> must be created.</p><h3 id="cloudflare-ssl-error">CloudFlare SSL error</h3><p>GitLab allows using custom SSL certificate whereas GitHub does not. When switching DNS records to point to <code>&lt;username&gt;.github.io</code>, you need to downgrade CloudFlare Crypto SSL level from <em>Full (strict)</em> to <em>Full</em>.</p><ul class="list-inline tags" style="margin-left:0"><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/cloudflare">CloudFlare</a></li><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/docker">Docker</a></li><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/git">Git</a></li><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/github">GitHub</a></li><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/gitlab">GitLab</a></li><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/hugo">Hugo</a></li><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/nodejs">NodeJS</a></li></ul></div></div><div class="blog-post"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="8937917223" data-ad-format="auto"></ins></div><div class="row"><div id="disqus_thread"></div><script>!function(){if("localhost"!=window.location.hostname){var e=document.createElement("script");e.type="text/javascript",e.async=!0;e.src="https://leowkahman.disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}}()</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div><div class="col-sm-4 blog-sidebar"><div class="sidebar-module"><script>!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx=partner-pub-8585963436723502:5716828028";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><gcse:search></gcse:search></div><div class="sidebar-module"><h4>Recent Posts</h4><ul class="list-unstyled posts-recent"><li><a href="https://www.leowkahman.com/2018/01/12/exclude-adsense-ads-from-specific-posts-on-hugo/">Exclude Adsense ads from specific posts on Hugo</a></li><li><a href="https://www.leowkahman.com/2018/01/09/setup-nodejs-with-apache-proxypass-on-raspberry-pi/">Setup NodeJS with Apache ProxyPass on Raspberry Pi</a></li><li><a href="https://www.leowkahman.com/2018/01/02/workaround-to-failure-to-download-extra-files-ttf-mscorefonts-installer/">Workaround to Failure to download extra files ttf-mscorefonts-installer</a></li><li><a href="https://www.leowkahman.com/2017/12/31/solution-to-lag-during-dota-2-alchemist-acid-spray-on-ubuntu-17-10/">Solution to lag during DOTA 2 Alchemist acid spray on Ubuntu 17.10</a></li><li><a href="https://www.leowkahman.com/2017/12/29/cloud-storage-solutions-for-linux/">Cloud storage solutions for Linux</a></li></ul></div><div class="sidebar-module"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="6069940020" data-ad-format="auto"></ins></div><div class="sidebar-module"><h4>Categories</h4><ul class="list-unstyled posts-recent"><li><a href="https://www.leowkahman.com/categories/web/">web</a></li><li><a href="https://www.leowkahman.com/categories/network/">network</a></li><li><a href="https://www.leowkahman.com/categories/software/">software</a></li><li><a href="https://www.leowkahman.com/categories/hardware/">hardware</a></li><li><a href="https://www.leowkahman.com/categories/cloud/">cloud</a></li></ul></div><div class="sidebar-module"><div id="amzn-assoc-ad-2cb50066-d10a-485e-9416-70d5db8469a8"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&adInstanceId=2cb50066-d10a-485e-9416-70d5db8469a8"></script></div></div></div></div><footer class="blog-footer"><div class="container"><div class="row"><div class="col-sm-8 col-xs-6"><ul class="list-inline links"><li><a href="https://status.leowkahman.com/">Uptime</a></li></ul></div><div class="col-sm-4 col-xs-6"><ul class="list-inline"><li><a target="_blank" href="/index.xml"><i class="fa fa-rss fa-lg"></i></a></li><li><a target="_blank" href="https://stackexchange.com/users/6729082/leow-kah-man"><i class="fa fa-stack-exchange fa-lg"></i></a></li><li><a target="_blank" href="https://github.com/kmleow"><i class="fa fa-github fa-lg"></i></a></li><li><a target="_blank" href="https://www.linkedin.com/in/kmleow"><i class="fa fa-linkedin fa-lg"></i></a></li><li><a target="_blank" href="https://www.facebook.com/LeowKahMan"><i class="fa fa-facebook fa-lg"></i></a></li></ul></div></div></div><div class="container"><div class="col-sm-12 row"><p>Except as otherwise noted, the content of this page is licensed under the <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>,<br/>code samples are licensed under the <a href="https://tldrlegal.com/license/mit-license">MIT License</a>.</p></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha256-Daf8GuI2eLKHJlOWLRR/zRy9Clqcj4TUSumbxYH9kGI=" crossorigin="anonymous"></script><script src="/js/custom.js?v=1.0.1"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>[].forEach.call(document.querySelectorAll(".adsbygoogle"),function(){(adsbygoogle=window.adsbygoogle||[]).push({})})</script><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-61838818-1","auto"),ga("send","pageview"),ga("set","forceSSL",!0)</script></body></html>