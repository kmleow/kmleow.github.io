<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-eval' 'unsafe-inline' data: https:; img-src 'self' data: https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https:; object-src 'self'"/><meta name="viewport" content="width=device-width,initial-scale=1"><title>GitLab CI remove priority zero from Hugo sitemap</title><meta name="msvalidate.01" content="009F12474AB330989749B979B5868A7F"/><meta name="google-site-verification" content="in8GfCIv-CYlwD5AxO0jVMlrUy1s42a_-cxlOWdv4U0"/><meta name="yandex-verification" content="c29e9c1084b24e1d"/><meta name="description" content="Configure GitLab CI runner to remove unwanted priority zero XML nodes from sitemap.xml."/><meta name="author" content="Leow Kah Man"/><link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192"/><link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32"/><link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16"/><link rel="canonical" href="https://www.leowkahman.com/2017/09/10/gitlab-ci-remove-priority-zero-from-hugo-sitemap/"><link href="" rel="alternate" type="application/rss+xml" title="Leow Kah Man - Tech Blog"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" integrity="sha256-Zd1icfZ72UBmsId/mUcagrmN7IN5Qkrvh75ICHIQVTk=" crossorigin="anonymous"/><link rel="stylesheet" href="/css/custom.css?v=1.0.0"/><style id="antiClickjack">body{display:none!important}</style><script>if(self===top){var antiClickjack=document.getElementById("antiClickjack");antiClickjack.parentNode.removeChild(antiClickjack)}else top.location=self.location</script><script>function redirectToCorrectDomainIfRequired(){for(var o=["www.leowkahman.com","localhost"],e=0;e<o.length;e++)if(window.location.hostname==o[e])return;window.location="https://www.leowkahman.com"+window.location.pathname}redirectToCorrectDomainIfRequired()</script></head><body><nav class="navbar navbar-default navbar-static-top"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">Leow Kah Man - Tech Blog</a></div><div id="navbar" class="navbar-collapse collapse"><ul class="nav navbar-nav"></ul><ul class="nav navbar-nav navbar-right"><li><a href="/about/">About</a></li><li><a href="/contact/">Contact</a></li></ul></div></div></nav><div class="container"><div class="row"><div class="col-sm-12"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="7600784826" data-ad-format="auto"></ins></div></div><div class="row"><div class="col-sm-8 blog-main"><div class="row"><div class="blog-main blog-post"><h1 class="blog-post-title">GitLab CI remove priority zero from Hugo sitemap</h1><p class="blog-post-meta"><i class="fa fa-calendar"></i> Published: 10 September 2017 &nbsp;|&nbsp; <i class="fa fa-calendar-check-o"></i> Last updated: 16 February 2018 &nbsp;|&nbsp; <i class="fa fa-folder"></i> <a href="https://www.leowkahman.com/categories/web">Web</a></p><ul class="list-inline share" style="margin-top:15px;margin-left:0"><li class="facebook-share"><a target="_blank" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.leowkahman.com%2f2017%2f09%2f10%2fgitlab-ci-remove-priority-zero-from-hugo-sitemap%2f"><i class="fa fa-facebook fa-lg"></i> Facebook</a></li><li class="googleplus-share"><a target="_blank" href="https://plus.google.com/share?url=https%3a%2f%2fwww.leowkahman.com%2f2017%2f09%2f10%2fgitlab-ci-remove-priority-zero-from-hugo-sitemap%2f"><i class="fa fa-google-plus fa-lg"></i> Google+</a></li><li class="twitter-share"><a target="_blank" href="https://twitter.com/share?url=https%3a%2f%2fwww.leowkahman.com%2f2017%2f09%2f10%2fgitlab-ci-remove-priority-zero-from-hugo-sitemap%2f&amp;text=GitLab%20CI%20remove%20priority%20zero%20from%20Hugo%20sitemap"><i class="fa fa-twitter fa-lg"></i> Twitter</a></li><li class="reddit-share"><a target="_blank" href="http://reddit.com/submit?url=https%3a%2f%2fwww.leowkahman.com%2f2017%2f09%2f10%2fgitlab-ci-remove-priority-zero-from-hugo-sitemap%2f&amp;title=GitLab%20CI%20remove%20priority%20zero%20from%20Hugo%20sitemap"><i class="fa fa-reddit fa-lg"></i> Reddit</a></li><li class="linkedin-share"><a target="_blank" href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.leowkahman.com%2f2017%2f09%2f10%2fgitlab-ci-remove-priority-zero-from-hugo-sitemap%2f"><i class="fa fa-linkedin fa-lg"></i> LinkedIn</a></li></ul><p>Hugo static site generator generates sitemap.xml that include priority zero URLs. These are the taxanomies, tags and categories. To prevent these from appearing in Google Search results, GitLab CI can be configured to remove unwanted XML nodes (priority 0) from sitemap.xml.</p><p></p><h2 id="motivation">Motivation</h2><p>Need to get rid of taxanomies from sitemap.xml so that they do not appear in Google Search results. Previously, I built and published my blog from my laptop. I had a <a href="/2017/03/20/remove-taxanomies-from-hugo-sitemap">PowerShell script for removing Hugo taxanomies</a>. After migrating to GitLab CI, I needed a new workaround.</p><h2 id="pre-requisites">Pre-requisites</h2><p>You need to have experience in setting up GitLab CI.</p><p>Otherwise, please read my earlier post <a href="/2017/08/15/hugo-static-site-generator-with-ci-deployment-using-gitlab/">Hugo Static Site Generator with CI Deployment using GitLab</a>.</p><h2 id="the-solution">The solution</h2><p>The high level idea is simple; let Hugo generate sitemap.xml as-is. Then remove priority 0 URLs from it.</p><p>There are several ways to do this; using i.e. <a href="http://xmlstar.sourceforge.net/">XMLStarlet</a> to remove XML nodes by XPath syntax or Regular Expression. For this, I decided to go with XMLStarlet as I feel it is easier for XML.</p><p>Previously, I was using NodeJS 6.11.x Alpine Docker image which was on an older Alpine 3.4. According to Alpine Linux Packages list, <a href="https://pkgs.alpinelinux.org/packages?name=xmlstarlet&amp;branch=&amp;repo=&amp;arch=&amp;maintainer=">XMLStarlet is available for Alpine 3.5 or higher</a>. As such, I had to change to Node 8.4.0 Alpine Docker image which uses Alpine 3.6.</p><p>Below is a snippet of my new GitLab CI YAML <code>.gitlab-ci.yml</code>:</p><pre><code class="language-yaml">image: node:8.4.0-alpine
before_script:
  - apk update &amp;&amp; apk add openssl ca-certificates xmlstarlet git
  - npm install
  - PATH=$(npm bin):$PATH
  - npm run version
pages:
  script:
  - npm run build
  - xml ed --inplace -N x=&quot;http://www.sitemaps.org/schemas/sitemap/0.9&quot; -d &quot;//x:url[x:priority='0']&quot; ./public/sitemap.xml
artifacts:
  paths:
  - public
  only:
  - master
</code></pre><p>The key bits to point out are:</p><ol><li><code>node:8.4.0-alpine</code> - to utilise a NodeJS Docker image that uses Alpine 3.6.</li><li><code>apk add xmlstarlet</code> - to install XMLStarlet package for editing XML.</li><li><code>xml ed ... //x:url[x:priority='0']</code> - command to remove priority 0 URL nodes.</li></ol><p>For the results, you can inspect my blog&rsquo;s <a href="https://www.leowkahman.com/sitemap.xml">sitemap.xml</a>.</p><h2 id="alternative-solution">Alternative solution</h2><p>If you are using a device that is not supported by Alpine Linux, you may consider this solution. As at January 2018, Alpine is still unavailable for ARMv7.</p><p>Use regular NodeJS image.</p><pre><code class="language-yaml">image: node:8
</code></pre><p>Below is a snippet of my package.json file making use of <a href="https://www.npmjs.com/package/pretty-xml">pretty-xml</a>:</p><pre><code class="language-json">&quot;scripts&quot;: {
  ...
  &quot;build-minify-xml&quot;: &quot;cat public/sitemap.xml | pretty-xml --minify | sed -r 's/&lt;url&gt;&lt;loc&gt;[^&lt;]+&lt;\\/loc&gt;(&lt;lastmod&gt;[^&lt;]+&lt;\\/lastmod&gt;)?&lt;priority&gt;0&lt;\\/priority&gt;&lt;\\/url&gt;//g' | cat &gt; public/sitemap.min.xml &amp;&amp; mv public/sitemap.min.xml public/sitemap.xml&quot;
  ...
},
&quot;dependencies&quot;: {
  &quot;pretty-xml&quot;: &quot;^1.2.1&quot;
}
</code></pre><ul class="list-inline tags" style="margin-left:0"><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/docker">Docker</a></li><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/gitlab">GitLab</a></li><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/hugo">Hugo</a></li><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/nodejs">NodeJS</a></li><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/raspberry-pi">Raspberry Pi</a></li></ul></div></div><div class="blog-post"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="8937917223" data-ad-format="auto"></ins></div><div class="row"><div id="disqus_thread"></div><script>!function(){if("localhost"!=window.location.hostname){var e=document.createElement("script");e.type="text/javascript",e.async=!0;e.src="https://leowkahman.disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}}()</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div><div class="col-sm-4 blog-sidebar"><div class="sidebar-module"><script>!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx=partner-pub-8585963436723502:5716828028";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><gcse:search></gcse:search></div><div class="sidebar-module"><h4>Recent Posts</h4><ul class="list-unstyled posts-recent"><li><a href="https://www.leowkahman.com/2018/03/13/using-raspbian-on-2gb-micro-sd-card/">Using Raspbian on 2GB Micro SD Card</a></li><li><a href="https://www.leowkahman.com/2018/03/09/lede-on-unifi-d-link-dir-615-g2/">LEDE on UniFi D-Link DIR-615 G2</a></li><li><a href="https://www.leowkahman.com/2018/02/10/backup-disk-by-cloning-using-clonezilla/">Backup disk by cloning using Clonezilla</a></li><li><a href="https://www.leowkahman.com/2018/01/12/exclude-adsense-ads-from-specific-posts-on-hugo/">Exclude Adsense ads from specific posts on Hugo</a></li><li><a href="https://www.leowkahman.com/2018/01/09/setup-nodejs-with-apache-proxypass-on-raspberry-pi/">Setup NodeJS with Apache ProxyPass on Raspberry Pi</a></li></ul></div><div class="sidebar-module"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="6069940020" data-ad-format="auto"></ins></div><div class="sidebar-module"><h4>Categories</h4><ul class="list-unstyled posts-recent"><li><a href="https://www.leowkahman.com/categories/web/">web</a></li><li><a href="https://www.leowkahman.com/categories/network/">network</a></li><li><a href="https://www.leowkahman.com/categories/software/">software</a></li><li><a href="https://www.leowkahman.com/categories/hardware/">hardware</a></li><li><a href="https://www.leowkahman.com/categories/cloud/">cloud</a></li></ul></div></div></div></div><footer class="blog-footer"><div class="container"><div class="row"><div class="col-sm-8 col-xs-6"><ul class="list-inline links"><li><a href="/privacy-policy/">Privacy Policy</a></li><li><a href="https://status.leowkahman.com/">Uptime</a></li></ul></div><div class="col-sm-4 col-xs-6"><ul class="list-inline"><li><a target="_blank" href="/index.xml"><i class="fa fa-rss fa-lg"></i></a></li><li><a target="_blank" href="https://stackexchange.com/users/6729082/leow-kah-man"><i class="fa fa-stack-exchange fa-lg"></i></a></li><li><a target="_blank" href="https://github.com/kmleow"><i class="fa fa-github fa-lg"></i></a></li><li><a target="_blank" href="https://www.linkedin.com/in/kmleow"><i class="fa fa-linkedin fa-lg"></i></a></li><li><a target="_blank" href="https://www.facebook.com/LeowKahMan"><i class="fa fa-facebook fa-lg"></i></a></li></ul></div></div></div><div class="container"><div class="col-sm-12 row"><p>I am a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for sites to earn advertising fees by advertising and linking to amazon.com.</p><p>Except as otherwise noted, the content of this page is licensed under the <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>,<br/>code samples are licensed under the <a href="https://tldrlegal.com/license/mit-license">MIT License</a>.</p></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha256-Daf8GuI2eLKHJlOWLRR/zRy9Clqcj4TUSumbxYH9kGI=" crossorigin="anonymous"></script><script src="/js/custom.js?v=1.0.1"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>[].forEach.call(document.querySelectorAll(".adsbygoogle"),function(){(adsbygoogle=window.adsbygoogle||[]).push({})})</script><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-61838818-1","auto"),ga("send","pageview"),ga("set","forceSSL",!0)</script></body></html>