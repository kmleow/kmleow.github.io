<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-eval' 'unsafe-inline' data: https:; img-src 'self' data: https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https:; object-src 'self'"/><meta name="viewport" content="width=device-width,initial-scale=1"><title>Block ads with OpenWRT dnsmasq</title><meta name="msvalidate.01" content="009F12474AB330989749B979B5868A7F"/><meta name="google-site-verification" content="in8GfCIv-CYlwD5AxO0jVMlrUy1s42a_-cxlOWdv4U0"/><meta name="yandex-verification" content="c29e9c1084b24e1d"/><meta name="description" content="Block ads and cryptocoin miners with OpenWRT dnsmasq and automate downloading of the latest list once a week"/><meta name="author" content="Leow Kah Man"/><link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192"/><link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32"/><link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16"/><link rel="canonical" href="https://www.leowkahman.com/2017/07/23/block-ads-with-openwrt-dnsmasq/"><link href="" rel="alternate" type="application/rss+xml" title="Leow Kah Man - Tech Blog"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" integrity="sha256-Zd1icfZ72UBmsId/mUcagrmN7IN5Qkrvh75ICHIQVTk=" crossorigin="anonymous"/><link rel="stylesheet" href="/css/custom.css?v=1.0.0"/><style id="antiClickjack">body{display:none!important}</style><script>if(self===top){var antiClickjack=document.getElementById("antiClickjack");antiClickjack.parentNode.removeChild(antiClickjack)}else top.location=self.location</script><script>function redirectToCorrectDomainIfRequired(){for(var o=["www.leowkahman.com","localhost"],e=0;e<o.length;e++)if(window.location.hostname==o[e])return;window.location="https://www.leowkahman.com"+window.location.pathname}redirectToCorrectDomainIfRequired()</script></head><body><nav class="navbar navbar-default navbar-static-top"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">Leow Kah Man - Tech Blog</a></div><div id="navbar" class="navbar-collapse collapse"><ul class="nav navbar-nav"></ul><ul class="nav navbar-nav navbar-right"><li><a href="/about/">About</a></li><li><a href="/contact/">Contact</a></li></ul></div></div></nav><div class="container"><div class="row"><div class="col-sm-12"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="7600784826" data-ad-format="auto"></ins></div></div><div class="row"><div class="col-sm-8 blog-main"><div class="row"><div class="blog-main blog-post"><h1 class="blog-post-title">Block ads with OpenWRT dnsmasq</h1><p class="blog-post-meta"><i class="fa fa-calendar"></i> Last updated on 26 September 2017 &nbsp; <i class="fa fa-folder"></i> <a href="https://www.leowkahman.com/categories/software">Software</a></p><ul class="list-inline share" style="margin-top:15px;margin-left:0"><li class="facebook-share"><a target="_blank" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.leowkahman.com%2f2017%2f07%2f23%2fblock-ads-with-openwrt-dnsmasq%2f"><i class="fa fa-facebook fa-lg"></i> Facebook</a></li><li class="googleplus-share"><a target="_blank" href="https://plus.google.com/share?url=https%3a%2f%2fwww.leowkahman.com%2f2017%2f07%2f23%2fblock-ads-with-openwrt-dnsmasq%2f"><i class="fa fa-google-plus fa-lg"></i> Google+</a></li><li class="twitter-share"><a target="_blank" href="https://twitter.com/share?url=https%3a%2f%2fwww.leowkahman.com%2f2017%2f07%2f23%2fblock-ads-with-openwrt-dnsmasq%2f&amp;text=Block%20ads%20with%20OpenWRT%20dnsmasq"><i class="fa fa-twitter fa-lg"></i> Twitter</a></li><li class="reddit-share"><a target="_blank" href="http://reddit.com/submit?url=https%3a%2f%2fwww.leowkahman.com%2f2017%2f07%2f23%2fblock-ads-with-openwrt-dnsmasq%2f&amp;title=Block%20ads%20with%20OpenWRT%20dnsmasq"><i class="fa fa-reddit fa-lg"></i> Reddit</a></li><li class="linkedin-share"><a target="_blank" href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.leowkahman.com%2f2017%2f07%2f23%2fblock-ads-with-openwrt-dnsmasq%2f"><i class="fa fa-linkedin fa-lg"></i> LinkedIn</a></li></ul><p>Block ads with OpenWRT dnsmasq and automate downloading of the latest list once a week. This solution can also be applied to blocking crytocoin miner domains.</p><p></p><h2 id="updates">Updates</h2><p><em>2017-09-26: Extended this article to include details on blocking cryptocoin miners.</em></p><h2 id="motivation">Motivation</h2><p>I do not mind seeing ads but they must not be intrusive. Try browsing my blog without ad blocker (if you are using it now) and you will see that I do not place ads in places where it disrupts natural flow of reading.</p><p>On PC, it is possible to install ad blockers into browsers. Some browsers even come with such a feature builtin too. However, you cannot do that on some devices, such as Smart TV. Therefore, I had to find an effective way to block ads with my OpenWRT router.</p><p>In September 2017, I came across news reports that some websites including seemingly legitimate ones are using their visitors web browsers to perform cryptocoin mining without their knowledge. Subsequently, I found that <a href="https://adblockplus.org/subscriptions">Adblock Plus subscriptions</a> page now has a filter called NoCoin. I raised an issue on GitHub requesting the author to introduce a <a href="https://github.com/hoshsadiq/adblock-nocoin-list/issues/4">host file variant of NoCoin</a> and the author created it within hours. I then updated this blog post to include additional information on that.</p><h2 id="steps">Steps</h2><h3 id="pre-requisites">Pre-requisites</h3><p>Firstly, I am assuming you are using OpenWRT. It comes with dnsmasq which is a DNS forwarder.</p><h3 id="bash-script-for-retrieving-latest-block-list-host-file">Bash script for retrieving latest block list host file</h3><p>Copy the script below into your OpenWRT. Place it somewhere that can persist over reboots, <code>/opt/dnsmasq-blocklist/update-blocklist.sh</code>.</p><pre><code class="language-bash">#!/bin/sh
set -e

mkdir -p /tmp/dnsmasq-blocklist
curl -s --max-filesize 524288 -o /tmp/dnsmasq-blocklist/danpollock.hosts &quot;http://someonewhocares.org/hosts/zero/hosts&quot;
curl -s --max-filesize 65536 -o /tmp/dnsmasq-blocklist/nocoin.hosts &quot;https://raw.githubusercontent.com/hoshsadiq/adblock-nocoin-list/master/hosts.txt&quot;
/etc/init.d/dnsmasq restart
</code></pre><p>Notes:</p><ol><li>As an example, the script above downloads Dan Pollock&rsquo;s host file. The line after it downloads cryptocoin miner host file. You can use whichever you prefer as long as it is not too big or else your OpenWRT device will run out of free RAM.</li><li>The block list is downloaded into an in-memory temporary storage for speed and to reduce writes to flash.</li><li>In this case, <code>curl</code> is preferred over <code>wget</code> because it can limit file size of download, in case the block list someday gets too big, the router may not have enough RAM to operate properly. Therefore, this acts as a safeguard.</li><li>If you want to download from an SSL source, you need to <a href="/2016/04/10/use-ssl-openwrt-opkg/">install SSL libraries</a>.</li></ol><h3 id="grant-execute-permission-to-the-script">Grant execute permission to the script</h3><p>Run the following command:</p><pre><code class="language-bash">chmod +x /opt/dnsmasq-blocklist/update-blocklist.sh
</code></pre><h3 id="run-the-script-on-startup">Run the script on startup</h3><p>Place the following lines into <code>/etc/rc.local</code> above the <code>exit 0</code> line.</p><pre><code class="language-bash"># Update dnsmasq block list
/opt/dnsmasq-blocklist/update-blocklist.sh
</code></pre><h3 id="update-block-list-once-a-week">Update block list once a week</h3><p>Edit crontab, <code>crontab -e</code>. Place the following line:</p><pre><code class="language-text">0 2 * * 1 /opt/dnsmasq-blocklist/update-blocklist.sh
</code></pre><p>If you are unfamiliar with cron syntax, the above means the script is executed once every Monday at 2am.</p><p>You can also add the line above via LuCI GUI, <code>System &gt; Scheduled Tasks</code>.</p><h3 id="configure-dnsmasq-to-load-the-block-list">Configure dnsmasq to load the block list</h3><p>Edit <code>/etc/config/dhcp</code>, add the line below into <code>config dnsmasq</code>:</p><pre><code class="language-text">config dnsmasq
    ...
    list addnhosts '/tmp/dnsmasq-blocklist/danpollock.hosts'
    list addnhosts '/tmp/dnsmasq-blocklist/nocoin.hosts'
    ...
</code></pre><p>Restart dnsmasq to take effect:</p><pre><code class="language-bash">/etc/init.d/dnsmasq restart
</code></pre><ul class="list-inline tags" style="margin-left:0"><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/openwrt">OpenWRT</a></li></ul></div></div><div class="blog-post"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="8937917223" data-ad-format="auto"></ins></div><div class="row"><div class="blog-post"><div id="disqus_thread"></div><script>!function(){if("localhost"!=window.location.hostname){var e=document.createElement("script");e.type="text/javascript",e.async=!0;e.src="https://leowkahman.disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}else document.write("Disqus comments are unavailable while serving on localhost or 127.0.0.1")}()</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div></div><div class="col-sm-4 blog-sidebar"><div class="sidebar-module"><script>!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx=partner-pub-8585963436723502:5716828028";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><gcse:search></gcse:search></div><div class="sidebar-module"><h4>Recent Posts</h4><ul class="list-unstyled posts-recent"><li><a href="https://www.leowkahman.com/2017/09/23/checklist-for-switching-from-windows-to-linux/">Checklist for switching from Windows to Linux</a></li><li><a href="https://www.leowkahman.com/2017/09/11/enforce-safe-search-on-google-youtube-bing/">Enforce Safe Search on Google, YouTube, Bing</a></li><li><a href="https://www.leowkahman.com/2017/09/10/gitlab-ci-remove-priority-zero-from-hugo-sitemap/">GitLab CI remove priority zero from Hugo sitemap</a></li><li><a href="https://www.leowkahman.com/2017/09/09/gitlab-ci-push-output-to-github/">GitLab CI push output to GitHub</a></li><li><a href="https://www.leowkahman.com/2017/09/05/tm-streamyx-router-wifi-security/">TM Streamyx Router Wi-Fi Security</a></li></ul></div><div class="sidebar-module"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="6069940020" data-ad-format="auto"></ins></div><div class="sidebar-module"><h4>Categories</h4><ul class="list-unstyled posts-recent"><li><a href="https://www.leowkahman.com/categories/web/">web</a></li><li><a href="https://www.leowkahman.com/categories/network/">network</a></li><li><a href="https://www.leowkahman.com/categories/software/">software</a></li><li><a href="https://www.leowkahman.com/categories/hardware/">hardware</a></li><li><a href="https://www.leowkahman.com/categories/cloud/">cloud</a></li></ul></div></div></div></div><footer class="blog-footer"><div class="container"><div class="row"><div class="col-sm-8 col-xs-6"><ul class="list-inline links"><li><a href="https://status.leowkahman.com/">Uptime</a></li></ul></div><div class="col-sm-4 col-xs-6"><ul class="list-inline"><li><a target="_blank" href="/index.xml"><i class="fa fa-rss fa-lg"></i></a></li><li><a target="_blank" href="https://stackexchange.com/users/6729082/leow-kah-man"><i class="fa fa-stack-exchange fa-lg"></i></a></li><li><a target="_blank" href="https://github.com/kmleow"><i class="fa fa-github fa-lg"></i></a></li><li><a target="_blank" href="https://www.linkedin.com/in/kmleow"><i class="fa fa-linkedin fa-lg"></i></a></li><li><a target="_blank" href="https://www.facebook.com/LeowKahMan"><i class="fa fa-facebook fa-lg"></i></a></li></ul></div></div></div><div class="container"><div class="col-sm-12 row"><p>Except as otherwise noted, the content of this page is licensed under the <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>,<br/>code samples are licensed under the <a href="https://tldrlegal.com/license/mit-license">MIT License</a>.</p></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha256-Daf8GuI2eLKHJlOWLRR/zRy9Clqcj4TUSumbxYH9kGI=" crossorigin="anonymous"></script><script src="/js/custom.js?v=1.0.1"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>[].forEach.call(document.querySelectorAll(".adsbygoogle"),function(){(adsbygoogle=window.adsbygoogle||[]).push({})})</script><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-61838818-1","auto"),ga("send","pageview"),ga("set","forceSSL",!0)</script></body></html>