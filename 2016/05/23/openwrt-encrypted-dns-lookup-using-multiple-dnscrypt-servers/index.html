<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>OpenWRT encrypted DNS lookup using multiple DNSCrypt servers</title><meta name="msvalidate.01" content="009F12474AB330989749B979B5868A7F"/><meta name="google-site-verification" content="in8GfCIv-CYlwD5AxO0jVMlrUy1s42a_-cxlOWdv4U0"/><meta name="yandex-verification" content="c29e9c1084b24e1d"/><meta name="description" content="Setup OpenWRT to query specific DNSCrypt server depending on domain name to resolve"/><meta name="author" content="Leow Kah Man"/><link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192"/><link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32"/><link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16"/><link rel="canonical" href="https://www.leowkahman.com/2016/05/23/openwrt-encrypted-dns-lookup-using-multiple-dnscrypt-servers/"><link href="" rel="alternate" type="application/rss+xml" title="Leow Kah Man - Tech Blog"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/vs.min.css" integrity="sha256-iGs2TpBtdfGr1FIgzGyO4CKAD1+2QaDswtMmJwDtHAs=" crossorigin="anonymous"/><link rel="stylesheet" href="/css/custom.css?v=1.0.0"/><style id="antiClickjack">body{display:none!important}</style><script>if(self===top){var antiClickjack=document.getElementById("antiClickjack");antiClickjack.parentNode.removeChild(antiClickjack)}else top.location=self.location</script><script>function redirectToCorrectDomainIfRequired(){for(var o=["www.leowkahman.com","localhost"],e=0;e<o.length;e++)if(window.location.hostname==o[e])return;window.location="https://www.leowkahman.com"+window.location.pathname}redirectToCorrectDomainIfRequired()</script></head><body><nav class="navbar navbar-default navbar-static-top"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">Leow Kah Man - Tech Blog</a></div><div id="navbar" class="navbar-collapse collapse"><ul class="nav navbar-nav"></ul><ul class="nav navbar-nav navbar-right"><li><a href="/about/">About</a></li><li><a href="/contact/">Contact</a></li></ul></div></div></nav><div class="container"><div class="row"><div class="col-sm-8 blog-main"><div class="row"><div class="blog-main blog-post"><h1 class="blog-post-title">OpenWRT encrypted DNS lookup using multiple DNSCrypt servers</h1><p class="blog-post-meta"><i class="fa fa-calendar"></i> Published: 23 May 2016 &nbsp;|&nbsp; <i class="fa fa-folder"></i> <a href="https://www.leowkahman.com/categories/network">Network</a></p><ul class="list-inline share" style="margin-top:15px;margin-left:0"><li class="facebook-share"><a target="_blank" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.leowkahman.com%2f2016%2f05%2f23%2fopenwrt-encrypted-dns-lookup-using-multiple-dnscrypt-servers%2f"><i class="fa fa-facebook fa-lg"></i> Facebook</a></li><li class="twitter-share"><a target="_blank" href="https://twitter.com/share?url=https%3a%2f%2fwww.leowkahman.com%2f2016%2f05%2f23%2fopenwrt-encrypted-dns-lookup-using-multiple-dnscrypt-servers%2f&amp;text=OpenWRT%20encrypted%20DNS%20lookup%20using%20multiple%20DNSCrypt%20servers"><i class="fa fa-twitter fa-lg"></i> Twitter</a></li><li class="reddit-share"><a target="_blank" href="http://reddit.com/submit?url=https%3a%2f%2fwww.leowkahman.com%2f2016%2f05%2f23%2fopenwrt-encrypted-dns-lookup-using-multiple-dnscrypt-servers%2f&amp;title=OpenWRT%20encrypted%20DNS%20lookup%20using%20multiple%20DNSCrypt%20servers"><i class="fa fa-reddit fa-lg"></i> Reddit</a></li><li class="linkedin-share"><a target="_blank" href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.leowkahman.com%2f2016%2f05%2f23%2fopenwrt-encrypted-dns-lookup-using-multiple-dnscrypt-servers%2f"><i class="fa fa-linkedin fa-lg"></i> LinkedIn</a></li></ul><p>Want to setup OpenWRT to query specific DNSCrypt server depending on domain name to resolve? Read on.</p><h2 id="overview">Overview</h2><p>It is assumed that you know what DNSCrypt is. Long story short, it is a protocol for encrypting DNS lookup traffic.</p><p>I installed <code>dnscrypt-proxy 1.4.3-1</code> from OpenWRT package repository. The proxy serves to receive incoming DNS requests then it makes an outbound request to DNSCrypt servers. It could load one proxy just fine but it could not initiate multiple instances until I applied a patch (more details below).</p><p>You may ask why do I need multiple when a single Anycast DNS server can give you the closest server? Sometimes the closest server does not have the content that you want; one way of geo-blocking by content providers. Solution is to use a UK DNS server to lookup a UK address, a US DNS server for US address, etc.</p><h2 id="how-to-setup">How to setup</h2><p>Install <code>dnscrypt-proxy</code> if you have not already. As mentioned earlier, the version I have at time of writing is <code>1.4.3-1</code>.</p><p>Stop the service:</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/etc/init.d/dnscrypt-proxy stop
</code></pre></div><p>This version needs to be patched to support multiple instances. Patch the file at <code>/etc/init.d/dnscrypt-proxy</code> with the following, copied from <a href="http://wuffleton.com/hacks/dnscrypt-openwrt/">here</a>:</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e">#!/bin/sh /etc/rc.common
</span><span style="color:#75715e"></span><span style="color:#75715e"># dnscrypt-proxy init-script utilizing procd to support multiple instances at once</span>

START<span style="color:#f92672">=</span><span style="color:#ae81ff">50</span>
USE_PROCD<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>

dnscrypt_instance<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    config_get address         <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#39;address&#39;</span>
    config_get port            <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#39;port&#39;</span>
    config_get resolver        <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#39;resolver&#39;</span>
    config_get resolvers_list  <span style="color:#e6db74">&#34;</span>$1<span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#39;resolvers_list&#39;</span>

    procd_open_instance
    procd_set_param command <span style="color:#e6db74">&#34;/usr/sbin/dnscrypt-proxy&#34;</span>
    procd_append_param command -a <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>address<span style="color:#e6db74">}</span><span style="color:#e6db74">:</span><span style="color:#e6db74">${</span>port<span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
    procd_append_param command -u nobody
    procd_append_param command -L <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>resolvers_list<span style="color:#66d9ef">:-</span><span style="color:#e6db74">&#39;/usr/share/dnscrypt-proxy/dnscrypt-resolvers.csv&#39;</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
    procd_append_param command -R <span style="color:#e6db74">&#34;</span><span style="color:#e6db74">${</span>resolver<span style="color:#66d9ef">:-</span><span style="color:#e6db74">&#39;opendns&#39;</span><span style="color:#e6db74">}</span><span style="color:#e6db74">&#34;</span>
    procd_close_instance
<span style="color:#f92672">}</span>

start_service <span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    config_load dnscrypt-proxy
    config_foreach dnscrypt_instance dnscrypt-proxy
<span style="color:#f92672">}</span>

service_triggers<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    procd_add_reload_trigger <span style="color:#e6db74">&#34;dnscrypt-proxy&#34;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Overwrite <code>/usr/share/dnscrypt-proxy/dnscrypt-resolvers.csv</code> with a newer version from <a href="https://raw.githubusercontent.com/jedisct1/dnscrypt-proxy/master/dnscrypt-resolvers.csv">GitHub</a>. This is to give us more DNSCrypt servers to choose from.</p><p>Next, edit <code>/etc/config/dnscrypt-proxy</code> to configure the instances. Below is a sample with 2 instances; one with Anycast support listening on port 5353, another without located in the UK listening on port 5354:</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">config dnscrypt-proxy
    option address &#39;127.0.0.1&#39;
    option port &#39;5353&#39;
    option resolver &#39;cisco&#39;
    option resolvers_list &#39;/usr/share/dnscrypt-proxy/dnscrypt-resolvers.csv&#39;

config dnscrypt-proxy
    option address &#39;127.0.0.1&#39;
    option port &#39;5354&#39;
    option resolver &#39;fvz-rec-gb-lon-01&#39;
    option resolvers_list &#39;/usr/share/dnscrypt-proxy/dnscrypt-resolvers.csv&#39;
</code></pre></div><p>Start DNSCrypt:</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">/etc/init.d/dnscrypt-proxy start
</code></pre></div><h2 id="testing">Testing</h2><p>Install <code>bind-tools</code> so that we can use <code>dig</code> command to lookup DNS information:</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">opkg update
opkg install bind-tools
</code></pre></div><p>Lookup DNS record of <a href="http://www.google.com">www.google.com</a> using:</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">dig 127.0.0.1 -p <span style="color:#f92672">[</span>port<span style="color:#f92672">]</span> www.google.com
</code></pre></div><p>Substitute [port] with whatever that you have defined in <code>/etc/config/dnscrypt-proxy</code>. Below is an example of the output from UK DNS server:</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">...
;; QUESTION SECTION:
;www.google.com.                        IN      A

;; ANSWER SECTION:
www.google.com.         144     IN      A       216.58.213.164
...
</code></pre></div><p>As shown above, the IP address of <a href="http://www.google.com">www.google.com</a> is <code>216.58.213.164</code> whereas if I lookup against an Anycast DNS server, the response I get is  <code>172.217.24.196</code>, somewhere much closer to me than the former.</p><h2 id="use-specific-dns-server-to-lookup-one-or-more-host-names">Use specific DNS server to lookup one or more host names</h2><p>Edit <code>/etc/config/dhcp</code>. The gist is <code>list server ...</code> lines.</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">config dnsmasq
    ...
    option noresolv &#39;1&#39;
    list server &#39;/[UK server host name]/127.0.0.1#5354&#39;
    list server &#39;127.0.0.1#5353&#39;
    list server &#39;/pool.ntp.org/8.8.8.8&#39;
</code></pre></div><p><code>noresolv '1'</code> is to prevent using any upstream DNS server other than those specified in this file. Substitute <code>[UK server host name]</code> with a real one of course. You may add multiple lines. Just keep them above the <code>list server '127.0.0.1#5353'</code> line.</p><p>IMPORTANT: Note that DNSCrypt requires time to be synchronised. Time synchronisation is performed against a host name but your DNS server is unavailable to perform lookups. This presents a chicken and egg problem. To mitigate this problem, a bypass is required for <code>pool.ntp.org</code> (assuming this is the NTP server configured in your OpenWRT) such that the lookup will be performed by a public DNS server i.e. <code>8.8.8.8</code>, a Google DNS server. Rules are parsed top-down so subsequent lookups of <code>pool.ntp.org</code> will not reach Google DNS.</p><h2 id="on-boot-in-case-dnscrypt-fails-to-start">On boot, in case DNSCrypt fails to start</h2><p>This is very likely due to Internet connection not available yet at time of starting DNSCrypt. In such a case, the workaround is to wait for Internet connection to be available before restarting DNSCrypt. Add the following lines into <code>/etc/rc.local</code>:</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Wait until Internet connection is available</span>
<span style="color:#66d9ef">for</span> i in <span style="color:#f92672">{</span>1..60<span style="color:#f92672">}</span>; <span style="color:#66d9ef">do</span> ping -c1 -W1 8.8.8.8 &amp;&gt; /dev/null <span style="color:#f92672">&amp;&amp;</span> break; <span style="color:#66d9ef">done</span>

<span style="color:#75715e"># Restart DNSCrypt proxy as it requires a successful time sync for its encryption to work</span>
/etc/init.d/dnscrypt-proxy restart
</code></pre></div><p>I am using <code>ping</code> to test whether Internet connection is available. This is not the best option but I did not want to invest too much time on this. Others have suggested using <code>sleep</code> command. If you know a better way, please share that as a comment below.</p><ul class="list-inline tags" style="margin-left:0"><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/dns">DNS</a></li><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/openwrt">OpenWRT</a></li></ul></div></div><div class="row"><div id="disqus_thread"></div><script>!function(){if("localhost"!=window.location.hostname){var e=document.createElement("script");e.type="text/javascript",e.async=!0;e.src="https://leowkahman.disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}}()</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div><div class="col-sm-4 blog-sidebar"><div class="sidebar-module"><script>!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx=partner-pub-8585963436723502:5716828028";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><gcse:search></gcse:search></div><div class="sidebar-module"><h4>Recent Posts</h4><ul class="list-unstyled posts-recent"><li><a href="https://www.leowkahman.com/2020/02/01/speedtest-openwrt-with-flow-offloading/">Speedtest OpenWRT with flow offloading</a></li><li><a href="https://www.leowkahman.com/2019/02/06/ultrawide-monitor-on-linux/">Ultrawide monitor on Linux</a></li><li><a href="https://www.leowkahman.com/2019/02/03/switched-from-ubuntu-to-linux-mint/">Switched from Ubuntu to Linux Mint</a></li><li><a href="https://www.leowkahman.com/2018/08/11/reduce-internet-lag-on-openwrt/">Reduce internet lag on OpenWRT</a></li><li><a href="https://www.leowkahman.com/2018/05/29/workaround-to-wifi-issues-on-openwrt-lede/">Workaround to Wi-Fi issues on OpenWRT LEDE</a></li></ul></div><div class="sidebar-module"><h4>Categories</h4><ul class="list-unstyled posts-recent"><li><a href="https://www.leowkahman.com/categories/software/">software</a></li><li><a href="https://www.leowkahman.com/categories/web/">web</a></li><li><a href="https://www.leowkahman.com/categories/network/">network</a></li><li><a href="https://www.leowkahman.com/categories/hardware/">hardware</a></li><li><a href="https://www.leowkahman.com/categories/programming/">programming</a></li></ul></div></div></div></div><footer class="blog-footer"><div class="container"><div class="row"><div class="col-sm-8 col-xs-6"><ul class="list-inline links"><li><a href="/privacy-policy/">Privacy Policy</a></li></ul></div><div class="col-sm-4 col-xs-6"><ul class="list-inline"><li><a target="_blank" href="/index.xml"><i class="fa fa-rss fa-lg"></i></a></li><li><a target="_blank" href="https://stackexchange.com/users/6729082/leow-kah-man"><i class="fa fa-stack-exchange fa-lg"></i></a></li><li><a target="_blank" href="https://github.com/kmleow"><i class="fa fa-github fa-lg"></i></a></li><li><a target="_blank" href="https://twitter.com/kmleow"><i class="fa fa-twitter fa-lg"></i></a></li><li><a target="_blank" href="https://www.linkedin.com/in/kmleow"><i class="fa fa-linkedin fa-lg"></i></a></li><li><a target="_blank" href="https://www.facebook.com/LeowKahMan"><i class="fa fa-facebook fa-lg"></i></a></li><li><a target="_blank" href="https://www.paypal.me/leowkahman/5usd"><i class="fa fa-paypal fa-lg"></i></a></li></ul></div></div></div><div class="container"><div class="col-sm-12 row"><p>Except as otherwise noted, the content of this page is licensed under the <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>,<br/>code samples are licensed under the <a href="https://tldrlegal.com/license/mit-license">MIT License</a>. Third-party product names and logos may be the trademarks of their respective owners.</p></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js" integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha256-Daf8GuI2eLKHJlOWLRR/zRy9Clqcj4TUSumbxYH9kGI=" crossorigin="anonymous"></script><script src="/js/custom.js?v=1.0.1"></script><script data-ad-client="ca-pub-8585963436723502" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-61838818-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-61838818-1")</script></body></html>