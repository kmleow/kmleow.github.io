<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-eval' 'unsafe-inline' data: https:; img-src 'self' data: https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https:; object-src 'self'"/><meta name="viewport" content="width=device-width,initial-scale=1"><title>Apache 2 Event MPM and PHP 5 FastCGI on Raspberry Pi</title><meta name="msvalidate.01" content="009F12474AB330989749B979B5868A7F"/><meta name="google-site-verification" content="in8GfCIv-CYlwD5AxO0jVMlrUy1s42a_-cxlOWdv4U0"/><meta name="yandex-verification" content="c29e9c1084b24e1d"/><meta name="description" content="I have been running my blog on Apache 2 with Event MPM for a while and thought I should share my setup on Raspberry Pi 2 Model B with Raspbian"/><meta name="author" content="Leow Kah Man"/><link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192"/><link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32"/><link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16"/><link rel="canonical" href="https://www.leowkahman.com/2016/04/22/apache-2-event-mpm-and-php-5-fastcgi-on-raspberry-pi/"><link href="" rel="alternate" type="application/rss+xml" title="Leow Kah Man - Tech Blog"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" integrity="sha256-Zd1icfZ72UBmsId/mUcagrmN7IN5Qkrvh75ICHIQVTk=" crossorigin="anonymous"/><link rel="stylesheet" href="/css/custom.css?v=1.0.0"/><style id="antiClickjack">body{display:none!important}</style><script>if(self===top){var antiClickjack=document.getElementById("antiClickjack");antiClickjack.parentNode.removeChild(antiClickjack)}else top.location=self.location</script><script>function redirectToCorrectDomainIfRequired(){for(var o=["www.leowkahman.com","localhost"],e=0;e<o.length;e++)if(window.location.hostname==o[e])return;window.location="https://www.leowkahman.com"+window.location.pathname}redirectToCorrectDomainIfRequired()</script></head><body><nav class="navbar navbar-default navbar-static-top"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">Leow Kah Man - Tech Blog</a></div><div id="navbar" class="navbar-collapse collapse"><ul class="nav navbar-nav"></ul><ul class="nav navbar-nav navbar-right"><li><a href="/about/">About</a></li><li><a href="/contact/">Contact</a></li></ul></div></div></nav><div class="container"><div class="row"><div class="col-sm-12"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="7600784826" data-ad-format="auto"></ins></div></div><div class="row"><div class="col-sm-8 blog-main"><div class="row"><div class="blog-main blog-post"><h1 class="blog-post-title">Apache 2 Event MPM and PHP 5 FastCGI on Raspberry Pi</h1><p class="blog-post-meta"><i class="fa fa-calendar"></i> Published: 22 April 2016 &nbsp;|&nbsp; <i class="fa fa-folder"></i> <a href="https://www.leowkahman.com/categories/web">Web</a></p><ul class="list-inline share" style="margin-top:15px;margin-left:0"><li class="facebook-share"><a target="_blank" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.leowkahman.com%2f2016%2f04%2f22%2fapache-2-event-mpm-and-php-5-fastcgi-on-raspberry-pi%2f"><i class="fa fa-facebook fa-lg"></i> Facebook</a></li><li class="googleplus-share"><a target="_blank" href="https://plus.google.com/share?url=https%3a%2f%2fwww.leowkahman.com%2f2016%2f04%2f22%2fapache-2-event-mpm-and-php-5-fastcgi-on-raspberry-pi%2f"><i class="fa fa-google-plus fa-lg"></i> Google+</a></li><li class="twitter-share"><a target="_blank" href="https://twitter.com/share?url=https%3a%2f%2fwww.leowkahman.com%2f2016%2f04%2f22%2fapache-2-event-mpm-and-php-5-fastcgi-on-raspberry-pi%2f&amp;text=Apache%202%20Event%20MPM%20and%20PHP%205%20FastCGI%20on%20Raspberry%20Pi"><i class="fa fa-twitter fa-lg"></i> Twitter</a></li><li class="reddit-share"><a target="_blank" href="http://reddit.com/submit?url=https%3a%2f%2fwww.leowkahman.com%2f2016%2f04%2f22%2fapache-2-event-mpm-and-php-5-fastcgi-on-raspberry-pi%2f&amp;title=Apache%202%20Event%20MPM%20and%20PHP%205%20FastCGI%20on%20Raspberry%20Pi"><i class="fa fa-reddit fa-lg"></i> Reddit</a></li><li class="linkedin-share"><a target="_blank" href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.leowkahman.com%2f2016%2f04%2f22%2fapache-2-event-mpm-and-php-5-fastcgi-on-raspberry-pi%2f"><i class="fa fa-linkedin fa-lg"></i> LinkedIn</a></li></ul><p>I have been running my blog on Apache 2 with Event MPM for a while and thought I should share my setup on Raspberry Pi 2 Model B with Raspbian for the benefit of others.</p><p></p><h2 id="background">Background</h2><p>Previously, I blogged about <a href="/2016/03/05/lamp-stack-on-raspberry-pi-with-kodi-running-at-startup/">my LAMP setup</a>. I have since optimised my Apache 2.4 and PHP 5 settings to make them utilise less memory. This is crucial when my Pi has just 1GB RAM.</p><h2 id="assumptions">Assumptions</h2><p>You have Apache 2.4 currently setup with default MPM of Prefork and mod_php enabled.</p><h2 id="switching-apache-mpm-from-prefork-to-event-and-use-php-fastcgi">Switching Apache MPM from Prefork to Event and use PHP FastCGI</h2><p>Long story short, switching Apache 2 MPM from Prefork to Event helps to reduce memory usage. MPM is acronym for Multi-Processing Module.</p><p>Firstly, we need to install Apache FastCGI Module, PHP 5 FastCGI Process Manager (PHP5-FPM) and Apache 2 Event MPM:</p><pre><code class="language-bash">sudo apt-get install libapache2-mod-fastcgi php5-fpm apache2-mpm-event
</code></pre><p>Next, disable Apache Prefork and mod_php:</p><pre><code class="language-bash">sudo a2dismod mpm_prefork php5
</code></pre><p>Then, enable the following Apache modules:</p><pre><code class="language-bash">sudo a2enmod mpm_event actions fastcgi rewrite
</code></pre><p>If you are running a database server and some other memory hungry programs, you may want to tune down (for stability; prevent crashes) the Event MPM defaults a little at <code>/etc/apache2/mods-enabled/mpm_event.conf</code>:</p><pre><code class="language-text"># event MPM
# StartServers: initial number of server processes to start
# MinSpareThreads: minimum number of worker threads which are kept spare
# MaxSpareThreads: maximum number of worker threads which are kept spare
# ThreadsPerChild: constant number of worker threads in each server process
# MaxRequestWorkers: maximum number of worker threads
# MaxConnectionsPerChild: maximum number of requests a server process serves
&lt;IfModule mpm_event_module&gt;
  StartServers             2
  MinSpareThreads          25
  MaxSpareThreads          75
  ThreadLimit              64
  ThreadsPerChild          25
  #MaxRequestWorkers       150
  MaxRequestWorkers        100
  MaxConnectionsPerChild   0
&lt;/IfModule&gt;
</code></pre><p>After enabling FastCGI, create a new folder: <code>mkdir -p /var/www/fastcgi</code></p><p>Edit FastCGI configuration at <code>/etc/apache2/mods-enabled/fastcgi.conf</code>:</p><pre><code class="language-text">#Default
#&lt;IfModule mod_fastcgi.c&gt;
#  AddHandler fastcgi-script .fcgi
#  #FastCgiWrapper /usr/lib/apache2/suexec
#  FastCgiIpcDir /var/lib/apache2/fastcgi
#&lt;/IfModule&gt;

&lt;IfModule mod_fastcgi.c&gt;
  AddHandler fastcgi-script .fcgi
  #FastCgiWrapper /usr/lib/apache2/suexec
  FastCgiIpcDir /var/lib/apache2/fastcgi

  Alias /php5.fastcgi /var/www/fastcgi/php5.fastcgi
  AddHandler php-script .php
  FastCGIExternalServer /var/www/fastcgi/php5.fastcgi -socket /var/run/php5-fpm.sock
  Action php-script /php5.fastcgi virtual

  # This part is not necessary to get it to work but it stops anything else from being
  # accessed from it by mistake or maliciously.
  &lt;Directory &quot;/var/www/fastcgi&quot;&gt;
    Order allow,deny
    &lt;Files &quot;php5.fastcgi&quot;&gt;
      Order deny,allow
    &lt;/Files&gt;
  &lt;/Directory&gt;
&lt;/IfModule&gt;
</code></pre><p>Now, restart Apache:</p><pre><code class="language-bash">sudo service apache2 restart
</code></pre><p>Verify that Apache is indeed using Event MPM:</p><pre><code class="language-bash">sudo a2query -M
</code></pre><p>The output should be <code>event</code>.</p><p>Verify that PHP is indeed in FastCGI mode through <a href="https://secure.php.net/manual/en/function.phpinfo.php">phpinfo</a>. Server API should be FPM/FastCGI.</p><h2 id="uninstalling-apache-mod-php">Uninstalling Apache mod_php</h2><p>I realised that upon upgrading <code>libapache2-mod-php5</code>, my Apache will revert from Event MPM to Prefork. To make sure this does not recur, I had to purge it from my Pi:</p><pre><code class="language-bash">sudo apt-get purge libapache2-mod-php5
</code></pre><h2 id="tip-caching-static-pages-in-wordpress">Tip: Caching static pages in WordPress</h2><p>Linux uses unused memory for disk caching. If you are using WordPress cache plugins, you do not need to cache static pages in memory explicitly. Instead, cache to disk and let Linux decide what to cache in memory.</p><ul class="list-inline tags" style="margin-left:0"><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/apache">Apache</a></li><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/php">PHP</a></li><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/raspberry-pi">Raspberry Pi</a></li><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/raspbian">Raspbian</a></li></ul></div></div><div class="row"><h4>Support Me</h4><p>If this post helped you, would you buy me a cup of tea/coffee?</p><a title="PayPal" href="https://www.paypal.me/leowkahman/12"><i class="fa fa-2x fa-paypal"></i> </a>&nbsp;&nbsp; <a title="Bitcoin" href="bitcoin:14vH7vDj7eyvvc7mxCkrgTx2HUntpeKhAn?amount=0.001&amp;label=Tech%20Blog"><i class="fa fa-2x fa-btc"></i> </a><a title="Bitcoin QR code" href="/images/bitcoin.png"><i class="fa fa-2x fa-qrcode"></i></a></div><div class="blog-post"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="8937917223" data-ad-format="auto"></ins></div><div class="row"><div id="disqus_thread"></div><script>!function(){if("localhost"!=window.location.hostname){var e=document.createElement("script");e.type="text/javascript",e.async=!0;e.src="https://leowkahman.disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}}()</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div><div class="col-sm-4 blog-sidebar"><div class="sidebar-module"><script>!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx=partner-pub-8585963436723502:5716828028";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><gcse:search></gcse:search></div><div class="sidebar-module"><h4>Recent Posts</h4><ul class="list-unstyled posts-recent"><li><a href="https://www.leowkahman.com/2017/12/31/solution-to-lag-during-dota-2-alchemist-acid-spray-on-ubuntu-17-10/">Solution to lag during DOTA 2 Alchemist acid spray on Ubuntu 17.10</a></li><li><a href="https://www.leowkahman.com/2017/12/29/cloud-storage-solutions-for-linux/">Cloud storage solutions for Linux</a></li><li><a href="https://www.leowkahman.com/2017/12/22/cruising-on-quantum-of-the-seas/">Cruising on Quantum of the Seas</a></li><li><a href="https://www.leowkahman.com/2017/11/12/using-amazon-echo-outside-us/">Using Amazon Echo outside US</a></li><li><a href="https://www.leowkahman.com/2017/10/12/cwe-316-storing-secure-strings-in-dotnet-securestring/">CWE-316 storing secure strings in .NET SecureString</a></li></ul></div><div class="sidebar-module"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="6069940020" data-ad-format="auto"></ins></div><div class="sidebar-module"><h4>Categories</h4><ul class="list-unstyled posts-recent"><li><a href="https://www.leowkahman.com/categories/web/">web</a></li><li><a href="https://www.leowkahman.com/categories/network/">network</a></li><li><a href="https://www.leowkahman.com/categories/software/">software</a></li><li><a href="https://www.leowkahman.com/categories/hardware/">hardware</a></li><li><a href="https://www.leowkahman.com/categories/cloud/">cloud</a></li></ul></div></div></div></div><footer class="blog-footer"><div class="container"><div class="row"><div class="col-sm-8 col-xs-6"><ul class="list-inline links"><li><a href="https://status.leowkahman.com/">Uptime</a></li></ul></div><div class="col-sm-4 col-xs-6"><ul class="list-inline"><li><a target="_blank" href="/index.xml"><i class="fa fa-rss fa-lg"></i></a></li><li><a target="_blank" href="https://stackexchange.com/users/6729082/leow-kah-man"><i class="fa fa-stack-exchange fa-lg"></i></a></li><li><a target="_blank" href="https://github.com/kmleow"><i class="fa fa-github fa-lg"></i></a></li><li><a target="_blank" href="https://www.linkedin.com/in/kmleow"><i class="fa fa-linkedin fa-lg"></i></a></li><li><a target="_blank" href="https://www.facebook.com/LeowKahMan"><i class="fa fa-facebook fa-lg"></i></a></li></ul></div></div></div><div class="container"><div class="col-sm-12 row"><p>Except as otherwise noted, the content of this page is licensed under the <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>,<br/>code samples are licensed under the <a href="https://tldrlegal.com/license/mit-license">MIT License</a>.</p></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha256-Daf8GuI2eLKHJlOWLRR/zRy9Clqcj4TUSumbxYH9kGI=" crossorigin="anonymous"></script><script src="/js/custom.js?v=1.0.1"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>[].forEach.call(document.querySelectorAll(".adsbygoogle"),function(){(adsbygoogle=window.adsbygoogle||[]).push({})})</script><script>!function(e,a,t,n,c,g,o){e.GoogleAnalyticsObject="ga",e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,g=a.createElement("script"),o=a.getElementsByTagName("script")[0],g.async=1,g.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(g,o)}(window,document),ga("create","UA-61838818-1","auto"),ga("send","pageview"),ga("set","forceSSL",!0)</script></body></html>