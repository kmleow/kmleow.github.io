<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-eval' 'unsafe-inline' data: https:; img-src 'self' data: https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https:; object-src 'self'"/><meta name="viewport" content="width=device-width,initial-scale=1"><title>Setup 4096-bit OpenVPN on OpenWRT</title><meta name="msvalidate.01" content="009F12474AB330989749B979B5868A7F"/><meta name="google-site-verification" content="in8GfCIv-CYlwD5AxO0jVMlrUy1s42a_-cxlOWdv4U0"/><meta name="yandex-verification" content="c29e9c1084b24e1d"/><meta name="description" content="If you want to setup OpenVPN with 4096-bit key on OpenWRT, with a few tips and tricks in addition, read on"/><meta name="author" content="Leow Kah Man"/><link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192"/><link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32"/><link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16"/><link rel="canonical" href="https://www.leowkahman.com/2016/03/14/setup-4096-bit-openvpn-openwrt/"><link href="" rel="alternate" type="application/rss+xml" title="Leow Kah Man - Tech Blog"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" integrity="sha256-Zd1icfZ72UBmsId/mUcagrmN7IN5Qkrvh75ICHIQVTk=" crossorigin="anonymous"/><link rel="stylesheet" href="/css/custom.css?v=1.0.0"/><style id="antiClickjack">body{display:none!important}</style><script>if(self===top){var antiClickjack=document.getElementById("antiClickjack");antiClickjack.parentNode.removeChild(antiClickjack)}else top.location=self.location</script><script>function redirectToCorrectDomainIfRequired(){for(var o=["www.leowkahman.com","localhost"],e=0;e<o.length;e++)if(window.location.hostname==o[e])return;window.location="https://www.leowkahman.com"+window.location.pathname}redirectToCorrectDomainIfRequired()</script></head><body><nav class="navbar navbar-default navbar-static-top"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">Leow Kah Man - Tech Blog</a></div><div id="navbar" class="navbar-collapse collapse"><ul class="nav navbar-nav"></ul><ul class="nav navbar-nav navbar-right"><li><a href="/about/">About</a></li><li><a href="/contact/">Contact</a></li></ul></div></div></nav><div class="container"><div class="row"><div class="col-sm-12"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="7600784826" data-ad-format="auto"></ins></div></div><div class="row"><div class="col-sm-8 blog-main"><div class="row"><div class="blog-main blog-post"><h1 class="blog-post-title">Setup 4096-bit OpenVPN on OpenWRT</h1><p class="blog-post-meta"><i class="fa fa-calendar"></i> Published: 14 March 2016 &nbsp;|&nbsp; <i class="fa fa-folder"></i> <a href="https://www.leowkahman.com/categories/network">Network</a></p><ul class="list-inline share" style="margin-top:15px;margin-left:0"><li class="facebook-share"><a target="_blank" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.leowkahman.com%2f2016%2f03%2f14%2fsetup-4096-bit-openvpn-openwrt%2f"><i class="fa fa-facebook fa-lg"></i> Facebook</a></li><li class="googleplus-share"><a target="_blank" href="https://plus.google.com/share?url=https%3a%2f%2fwww.leowkahman.com%2f2016%2f03%2f14%2fsetup-4096-bit-openvpn-openwrt%2f"><i class="fa fa-google-plus fa-lg"></i> Google+</a></li><li class="twitter-share"><a target="_blank" href="https://twitter.com/share?url=https%3a%2f%2fwww.leowkahman.com%2f2016%2f03%2f14%2fsetup-4096-bit-openvpn-openwrt%2f&amp;text=Setup%204096-bit%20OpenVPN%20on%20OpenWRT"><i class="fa fa-twitter fa-lg"></i> Twitter</a></li><li class="reddit-share"><a target="_blank" href="http://reddit.com/submit?url=https%3a%2f%2fwww.leowkahman.com%2f2016%2f03%2f14%2fsetup-4096-bit-openvpn-openwrt%2f&amp;title=Setup%204096-bit%20OpenVPN%20on%20OpenWRT"><i class="fa fa-reddit fa-lg"></i> Reddit</a></li><li class="linkedin-share"><a target="_blank" href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.leowkahman.com%2f2016%2f03%2f14%2fsetup-4096-bit-openvpn-openwrt%2f"><i class="fa fa-linkedin fa-lg"></i> LinkedIn</a></li></ul><p>If you want to setup OpenVPN with 4096-bit key on OpenWRT, with a few tips and tricks in addition, read on.</p><p></p><h2 id="reasons-for-setting-up-vpn">Reasons for setting up VPN</h2><ol><li>To access your home network via a secure tunnel from outside.</li><li>To avoid port forwardings which opens up a direct pipe to your home devices, a potential security hole.</li><li>To deny others from eavesdropping on your Internet traffic when using public Wi-Fi.</li><li>To browse the Internet as if you are in your home country when you are abroad. This is useful in circumventing <a href="https://en.wikipedia.org/wiki/Geo-blocking">geo-blocking</a>.</li></ol><p>OpenVPN is probably the best open source implementation of VPN at this time. It is offered by all public VPN providers that I know of but encryption strength varies.</p><h2 id="setup">Setup</h2><h3 id="default-settings">Default settings</h3><p>Prior to using OpenVPN on OpenWRT, I was using OpenVPN on Network-attached Storage. I stopped using after realising that they use 1024-bit key. Then I setup OpenVPN on OpenWRT which as at time of writing this blog post defaults to 2048-bit key. While this is sufficient for today&rsquo;s needs, an attacker could potentially capture the encrypted data today to be decrypted using much better hardware in future.</p><h3 id="installing-openvpn-on-openwrt">Installing OpenVPN on OpenWRT</h3><p>Install <code>openvpn-easy-rsa</code> and <code>openvpn-openssl</code>. If you use OpenWRT GUI, install <code>luci-app-openvpn</code> as well. Ensure that your router has sufficient free space for these packages! I am unsure how much is required but very sure that routers with 4MB flash memory is insufficient.</p><h3 id="increasing-key-size-from-2048-to-4096-bit">Increasing key size from 2048 to 4096 bit</h3><p>Edit <code>/etc/easy-rsa/vars</code> using your preferred editor. If you are not sure how to edit, I recommend installing <code>nano</code> then edit the file by typing <code>nao /etc/easy-rsa/vars</code>.<br/>Set <code>export KEY_SIZE=4096</code>.</p><h3 id="other-settings">Other settings</h3><p>You should set the following fields so that you do not have to enter them for each key creation.</p><pre><code class="language-text">export KEY_COUNTRY=&quot;[2-letter country code]&quot;
export KEY_PROVINCE=&quot;[whatever]&quot;
export KEY_CITY=&quot;[whatever]&quot;
export KEY_ORG=&quot;[whatever]&quot;
export KEY_EMAIL=&quot;[whatever]&quot;
export KEY_OU=&quot;[whatever]&quot;

export KEY_NAME=&quot;[keyname]&quot;
</code></pre><h3 id="password-keys">Password keys</h3><p>For all steps below, when prompted to enter password for keys, leave them blank.</p><h3 id="clean-all">Clean all</h3><p>To delete everything in <code>/etc/easy-rsa/keys</code> folder, run <code>clean-all</code>. Be warned that this removes all existing keys! Use it only for starting afresh.</p><h3 id="generate-certificate-authority-key">Generate Certificate Authority key</h3><p>Create Certificate Authority (CA) key by running <code>build-ca</code>. This step produces <code>ca.crt</code> and <code>ca.key</code>. The former (certificate) is to be distributed to every client while the latter (key) must not be given out to anyone. If the key is compromised, you must recreate all keys beginning with <code>clean-all</code> step in previous paragraph.</p><h3 id="generate-diffie-hellman-key">Generate Diffie Hellman key</h3><p>Create Diffie Hellman (DH) key by running <code>build-dh</code>. <strong>Note that this takes hours if not days on a typical router!</strong> If you want this step to complete significantly faster, install OpenSSL onto your workstation and execute:</p><pre><code class="language-bash">openssl dhparam 4096 -out dh4096.pem
</code></pre><p>Be patient. A modern hardware may still require more than an hour to complete this step. The output is a file <code>dh4096.pem</code>. Copy this into <code>/etc/easy-rsa/keys</code>.</p><h3 id="generate-server-key">Generate server key</h3><pre><code class="language-bash">build-key-server server
</code></pre><p>This creates a server key called &lsquo;server&rsquo;.</p><h3 id="generate-client-keys">Generate client keys</h3><p>For each client, create a key with unique name. Besides this, do not create client keys with the same name as server key.</p><pre><code class="language-bash">build-key-pkcs12 clientname
</code></pre><p>This generates the following files:</p><ul><li>clientname.crt</li><li>clientname.key</li><li>clientname.p12</li></ul><h3 id="hardening-security">Hardening security</h3><p>While not required, enabling <a href="https://openvpn.net/index.php/open-source/documentation/howto.html#security">Transport Layer Security (TLS) authentication</a> is strongly recommended. Generate TLS key by running:</p><pre><code class="language-bash">openvpn --genkey --secret /etc/easy-rsa/keys/ta.key
</code></pre><p>This key is a shared secret. Therefore, must be copied to every client. If the server is set to <code>ta.key 0</code>, the client must be set to <code>ta.key 1</code> or vice versa.</p><h3 id="copy-all-keys-to-openvpn-folder">Copy all keys to openvpn folder</h3><pre><code class="language-bash">cd /etc/easy-rsa/keys
cp ca.crt ca.key dh4096.pem server.crt server.key ta.key /etc/openvpn
</code></pre><p>For subsequent configuration steps, point to <code>/etc/openvpn</code> for keys.</p><h3 id="server-configuration">Server configuration</h3><p>Edit <code>/etc/config/openvpn</code>. Add and edit where relevant the following:</p><pre><code class="language-text"># OpenVPN instance name must be unique
config openvpn 'myvpn'
    option enabled '1'
    option mode 'server'
    option tls_server '1'

    # Virtual network adapter name, must be unique
    option dev 'tun-local'

    # The default port number is 1194
    option port '1194'
    option proto 'udp'

    option status '/var/log/openvpn_status.log'
    option log '/tmp/openvpn.log'
    option mute '5'
    option persist_key '1'
    option persist_tun '1'
    option ca '/etc/openvpn/ca.crt'
    option cert '/etc/openvpn/server.crt'
    option key '/etc/openvpn/server.key'
    option dh '/etc/openvpn/dh4096.pem'

    # Instead of using the default Blowfish algorithm
    option cipher 'AES-256-CBC'

    # Set ta.key 0 for server and ta.key 1 on client or vice versa
    option tls_auth '/etc/openvpn/ta.key 0'

    option route_gateway 'dhcp'

    # Allows a VPN client to talk to another
    option client_to_client '1'

    # IMHO, compression should be decided at application layer
    option comp_lzo 'no'

    # Use a subnet where no other instance of OpenVPN is using
    option server '10.8.1.0 255.255.255.0'
    option verb '0'
    option float '1'
    option keepalive '10 120'

    # Do not comment this line
    list push 'comp-lzo no'

    # Redirects all client traffic to go through VPN
    list push 'redirect-gateway def1'

    # Tell client to use router's DNS forwarder, change this accordingly
    # You must configure firewall to allow this to flow through
    # Otherwise use Google DNS 8.8.8.8
    list push 'dhcp-option DNS 192.168.0.1'
</code></pre><p>Restart Openvpn:</p><pre><code class="language-bash">/etc/init.d/openvpn restart
</code></pre><p>Edit <code>/etc/config/network</code> and add the following. Note that <code>tun-local</code> must be replaced with whatever you have specified under <code>option dev</code> in previous step:</p><pre><code class="language-text">config interface 'vpn'
    option proto 'none'
    option auto '1'
    option ifname 'tun-local'
</code></pre><p>Restart network:</p><pre><code class="language-bash">/etc/init.d/network restart
</code></pre><p>Next, setup firewall by editing <code>/etc/config/firewall</code>. Create a firewall zone for the VPN:</p><pre><code class="language-text">config zone
    option name 'vpn'
    option input 'ACCEPT'
    option forward 'ACCEPT'
    option output 'ACCEPT'
    option masq '1'
    option network 'vpn'
</code></pre><p>Forward traffic from VPN to WAN:</p><pre><code class="language-text">config forwarding
    option dest 'wan'
    option src 'vpn'
</code></pre><p>Forward traffic from VPN to LAN:</p><pre><code class="language-text">config forwarding
    option dest 'lan'
    option src 'vpn'
</code></pre><p>Allow incoming connections via UDP port 1194:</p><pre><code class="language-text">config rule
    option name 'Allow-OpenVPN-Inbound'
    option target 'ACCEPT'
    option proto 'udp'
    option dest_port '1194'
    option src 'wan'
    option family 'ipv4'
</code></pre><p>Restart firewall: <code>/etc/init.d/firewall restart</code></p><h3 id="client-configuration">Client configuration</h3><p>Create <code>clientname.ovpn</code> file:</p><pre><code class="language-text">dev tun

# Protocol to use
proto udp

# Certificates
ca   ca.crt
cert clientname.crt
key  clientname.key

script-security 3
float
cipher AES-256-CBC
tls-auth ta.key 1
client
remote-cert-tls server

# Try the first, if fail try the second automatically
# Replace server-hostname with your hostname
remote server-hostname 1194
remote server-hostname 53
</code></pre><p>Copy the OVPN file along with the following files to the client:</p><ul><li>clientname.crt</li><li>clientname.key</li><li>ca.crt</li><li>ta.key</li></ul><p>Import the OVPN file using your preferred OpenVPN client. The client should automatically recognise the other four files. If not, explicitly point to them.</p><h2 id="troubleshooting">Troubleshooting</h2><p>Read on if you are facing issues. One of the solutions might be helpful to you.</p><h3 id="able-to-establish-connection-over-mobile-network-but-not-from-public-wi-fi">Able to establish connection over mobile network but not from public Wi-Fi</h3><p>The firewall at the public Wi-Fi network is probably blocking outgoing connections on UDP port 1194. Try using a different port instead of the default 1194. Alternatively, you could support multiple ports by adding an iptable rule per extra port. Below is an example of redirecting incoming UDP port 53 to 1194. UDP 53 is for DNS, very unlikely to be blocked:</p><pre><code class="language-bash"># Redirect UDP 53 to UDP 1194 OpenVPN
iptables -t nat -A PREROUTING -p udp -i pppoe-wan --dport 53 -j REDIRECT --to-port 1194
</code></pre><p>If this does not work for you, try using TCP port 443 by changing the following lines in <code>/etc/config/openvpn</code>:</p><pre><code class="language-text">option port '443'
option proto 'tcp'
</code></pre><h3 id="unable-to-connect-to-remote-lan-machines-via-vpn">Unable to connect to remote LAN machines via VPN</h3><p>Firstly, avoid using very common subnets such as <code>192.168.0.x</code> and <code>192.168.1.x</code>. If the source (where you are connecting to VPN from) and destination (where the VPN server is running) are on the same subnet, the destination cannot be reached. The server could push a route of that subnet explicitly overriding the client&rsquo;s route. In doing so however, it prevents connecting to the source LAN when client is connected to VPN. In short, stay away from very common subnets.</p><p>### Unable to ping any machine via VPN</p><p>I was having no problems connecting to VPN from my Android device but I was not able to connect from a Lubuntu notebook. After trying various settings, the setting that fixed the problem was <strong>turning on</strong> <code>comp-lzo</code> on the Lubuntu notebook. This is despite the server having set the comp-lzo to &lsquo;no&rsquo; explicitly and pushing that option to client too.</p><ul class="list-inline tags" style="margin-left:0"><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/openvpn">OpenVPN</a></li><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/openwrt">OpenWRT</a></li><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/security">Security</a></li></ul></div></div><div class="blog-post"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="8937917223" data-ad-format="auto"></ins></div><div class="row"><div id="disqus_thread"></div><script>!function(){if("localhost"!=window.location.hostname){var e=document.createElement("script");e.type="text/javascript",e.async=!0;e.src="https://leowkahman.disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}}()</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div><div class="col-sm-4 blog-sidebar"><div class="sidebar-module"><script>!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx=partner-pub-8585963436723502:5716828028";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><gcse:search></gcse:search></div><div class="sidebar-module"><h4>Recent Posts</h4><ul class="list-unstyled posts-recent"><li><a href="https://www.leowkahman.com/2018/03/31/how-to-fix-choppy-youtube-videos-on-old-laptop/">How to fix choppy YouTube videos on Firefox and Chrome on an old laptop</a></li><li><a href="https://www.leowkahman.com/2018/03/22/running-whatsapp-allo-todoist-onenote-on-ubuntu/">Running WhatsApp, Allo, Todoist, and OneNote on Ubuntu</a></li><li><a href="https://www.leowkahman.com/2018/03/13/using-raspbian-on-2gb-micro-sd-card/">Using Raspbian on 2GB Micro SD Card</a></li><li><a href="https://www.leowkahman.com/2018/03/09/lede-on-unifi-d-link-dir-615-g2/">LEDE on UniFi D-Link DIR-615 G2</a></li><li><a href="https://www.leowkahman.com/2018/02/10/backup-disk-by-cloning-using-clonezilla/">Backup disk by cloning using Clonezilla</a></li></ul></div><div class="sidebar-module"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="6069940020" data-ad-format="auto"></ins></div><div class="sidebar-module"><h4>Categories</h4><ul class="list-unstyled posts-recent"><li><a href="https://www.leowkahman.com/categories/web/">web</a></li><li><a href="https://www.leowkahman.com/categories/software/">software</a></li><li><a href="https://www.leowkahman.com/categories/network/">network</a></li><li><a href="https://www.leowkahman.com/categories/hardware/">hardware</a></li><li><a href="https://www.leowkahman.com/categories/cloud/">cloud</a></li></ul></div><div class="sidebar-module"><div id="amzn-assoc-ad-2cb50066-d10a-485e-9416-70d5db8469a8"></div><script async src="//z-na.amazon-adsystem.com/widgets/onejs?MarketPlace=US&adInstanceId=2cb50066-d10a-485e-9416-70d5db8469a8"></script></div></div></div></div><footer class="blog-footer"><div class="container"><div class="row"><div class="col-sm-8 col-xs-6"><ul class="list-inline links"><li><a href="/privacy-policy/">Privacy Policy</a></li><li><a href="https://status.leowkahman.com/">Uptime</a></li></ul></div><div class="col-sm-4 col-xs-6"><ul class="list-inline"><li><a target="_blank" href="/index.xml"><i class="fa fa-rss fa-lg"></i></a></li><li><a target="_blank" href="https://stackexchange.com/users/6729082/leow-kah-man"><i class="fa fa-stack-exchange fa-lg"></i></a></li><li><a target="_blank" href="https://github.com/kmleow"><i class="fa fa-github fa-lg"></i></a></li><li><a target="_blank" href="https://twitter.com/kmleow"><i class="fa fa-twitter fa-lg"></i></a></li><li><a target="_blank" href="https://www.linkedin.com/in/kmleow"><i class="fa fa-linkedin fa-lg"></i></a></li><li><a target="_blank" href="https://www.facebook.com/LeowKahMan"><i class="fa fa-facebook fa-lg"></i></a></li></ul></div></div></div><div class="container"><div class="col-sm-12 row"><p>I am a participant in the Amazon Services LLC Associates Program, an affiliate advertising program designed to provide a means for sites to earn advertising fees by advertising and linking to amazon.com.</p><p>Except as otherwise noted, the content of this page is licensed under the <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>,<br/>code samples are licensed under the <a href="https://tldrlegal.com/license/mit-license">MIT License</a>. Third-party product names and logos may be the trademarks of their respective owners.</p></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha256-Daf8GuI2eLKHJlOWLRR/zRy9Clqcj4TUSumbxYH9kGI=" crossorigin="anonymous"></script><script src="/js/custom.js?v=1.0.1"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>[].forEach.call(document.querySelectorAll(".adsbygoogle"),function(){(adsbygoogle=window.adsbygoogle||[]).push({})})</script><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-61838818-1","auto"),ga("send","pageview"),ga("set","forceSSL",!0)</script></body></html>