<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>OpenWRT redirect all NTP queries to specific servers</title><meta name="msvalidate.01" content="009F12474AB330989749B979B5868A7F"/><meta name="google-site-verification" content="in8GfCIv-CYlwD5AxO0jVMlrUy1s42a_-cxlOWdv4U0"/><meta name="yandex-verification" content="c29e9c1084b24e1d"/><meta name="description" content="Most devices allow you to set the Network Time Protocol (NTP) server to one that you prefer but there are some devices that have hardcoded NTP server hostname"/><meta name="author" content="Leow Kah Man"/><link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192"/><link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32"/><link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16"/><link rel="canonical" href="https://www.leowkahman.com/2016/01/06/openwrt-redirect-all-ntp-queries-to-specific-servers/"><link href="" rel="alternate" type="application/rss+xml" title="Leow Kah Man - Tech Blog"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/vs.min.css" integrity="sha256-iGs2TpBtdfGr1FIgzGyO4CKAD1+2QaDswtMmJwDtHAs=" crossorigin="anonymous"/><link rel="stylesheet" href="/css/custom.css?v=1.0.0"/><style id="antiClickjack">body{display:none!important}</style><script>if(self===top){var antiClickjack=document.getElementById("antiClickjack");antiClickjack.parentNode.removeChild(antiClickjack)}else top.location=self.location</script><script>function redirectToCorrectDomainIfRequired(){for(var o=["www.leowkahman.com","localhost"],e=0;e<o.length;e++)if(window.location.hostname==o[e])return;window.location="https://www.leowkahman.com"+window.location.pathname}redirectToCorrectDomainIfRequired()</script></head><body><nav class="navbar navbar-default navbar-static-top"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">Leow Kah Man - Tech Blog</a></div><div id="navbar" class="navbar-collapse collapse"><ul class="nav navbar-nav"></ul><ul class="nav navbar-nav navbar-right"><li><a href="/about/">About</a></li><li><a href="/contact/">Contact</a></li></ul></div></div></nav><div class="container"><div class="row"><div class="col-sm-8 blog-main"><div class="row"><div class="blog-main blog-post"><h1 class="blog-post-title">OpenWRT redirect all NTP queries to specific servers</h1><p class="blog-post-meta"><i class="fa fa-calendar"></i> Published: 6 January 2016 &nbsp;|&nbsp; <i class="fa fa-calendar-check-o"></i> Last updated: 8 April 2018 &nbsp;|&nbsp; <i class="fa fa-folder"></i> <a href="https://www.leowkahman.com/categories/network">Network</a></p><ul class="list-inline share" style="margin-top:15px;margin-left:0"><li class="facebook-share"><a target="_blank" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.leowkahman.com%2f2016%2f01%2f06%2fopenwrt-redirect-all-ntp-queries-to-specific-servers%2f"><i class="fa fa-facebook fa-lg"></i> Facebook</a></li><li class="twitter-share"><a target="_blank" href="https://twitter.com/share?url=https%3a%2f%2fwww.leowkahman.com%2f2016%2f01%2f06%2fopenwrt-redirect-all-ntp-queries-to-specific-servers%2f&amp;text=OpenWRT%20redirect%20all%20NTP%20queries%20to%20specific%20servers"><i class="fa fa-twitter fa-lg"></i> Twitter</a></li><li class="reddit-share"><a target="_blank" href="http://reddit.com/submit?url=https%3a%2f%2fwww.leowkahman.com%2f2016%2f01%2f06%2fopenwrt-redirect-all-ntp-queries-to-specific-servers%2f&amp;title=OpenWRT%20redirect%20all%20NTP%20queries%20to%20specific%20servers"><i class="fa fa-reddit fa-lg"></i> Reddit</a></li><li class="linkedin-share"><a target="_blank" href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.leowkahman.com%2f2016%2f01%2f06%2fopenwrt-redirect-all-ntp-queries-to-specific-servers%2f"><i class="fa fa-linkedin fa-lg"></i> LinkedIn</a></li></ul><p>Most devices allow you to set the <a href="https://en.wikipedia.org/wiki/Network_Time_Protocol">Network Time Protocol (NTP)</a> server to one that you prefer but there are some devices that have hardcoded NTP server hostname. This is mostly fine if all devices in your local network are synchronised to the same second but this is not always true. I have seen NTP servers that drift over 30 seconds. Not good&hellip;</p><h2 id="not-good-because">Not good because</h2><ol><li>You need all IP cameras to be in the correct time so that it is easier for you to piece evidence together from multiple cameras at specific time of an incident.</li><li>You need reliable NTP servers for which the manufacturer&rsquo;s hardcoded option is not.</li><li>IMHO, the most important reason is file synchronisation; so that every computer can agree on which copy of a file is the latest.</li></ol><h2 id="redirecting-ntp-requests-to-specific-server">Redirecting NTP requests to specific server</h2><p>Some manufacturers have hardcoded NTP servers in their NTP client. We could redirect all NTP requests to specific server or servers at router level. The solution I am sharing is specific to OpenWRT Chaos Calmer.</p><p>Note: This is not an Enterprise solution. This tutorial is ideal for home users only.</p><h3 id="defining-one-or-more-ntp-servers-to-use">Defining one or more NTP servers to use</h3><p>Check <strong>Enable NTP client</strong> and <strong>Provide NTP server</strong>. This is to configure the router to act as a NTP forwarder.</p><p>Pick your servers; <a href="http://www.pool.ntp.org/">pool.ntp.org</a> is a popular option but Malaysia seems to have (at time of writing) just one NTP server in the pool. This is fine if it is always working, unfortunately not. Therefore, I prefer Google Time Servers:</p><ul><li><code>time1.google.com</code></li><li><code>time2.google.com</code></li><li><code>time3.google.com</code></li><li><code>time4.google.com</code></li></ul><p>A small caveat: <a href="https://googleblog.blogspot.com/2011/09/time-technology-and-leaping-seconds.html">Google applies time smears</a> for which you may like or dislike.</p><p><a href="/images/2016/01/time-synchronization-system.png"><img src="/images/2016/01/time-synchronization-system.png" alt="Time Synchronization - System"></a></p><h3 id="redirect-all-ntp-queries-to-servers-defined">Redirect all NTP queries to servers defined</h3><p>Add a few lines into <code>Network &gt; Firewall &gt; Custom Rules</code> to redirect all NTP requests to the router&rsquo;s NTP forwarder regardless of the intended host name that your devices wish to connect to.</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Redirect NTP requests to go through router</span>
iptables -t nat -A PREROUTING -i br-lan -p udp --dport <span style="color:#ae81ff">123</span> -j DNAT --to 192.168.1.1
iptables -t nat -A PREROUTING -i br-guest -p udp --dport <span style="color:#ae81ff">123</span> -j DNAT --to 192.168.1.1
</code></pre></div><p>You may need to replace <code>br-lan</code> and <code>br-guest</code> if required. The former is my LAN network interface and the latter is my guest Wi-Fi network interface. Find yours under <code>Network &gt; Interfaces</code>. Also, substitute <code>192.168.1.1</code> with your router&rsquo;s IP.</p><h3 id="ensuring-time-is-up-to-date-as-soon-as-connection-is-available">Ensuring time is up-to-date as soon as connection is available</h3><p>When my router starts up, it takes random length of time to get connected to the Internet although usually under 30 seconds. Still, this delay sometimes causes my router&rsquo;s time not to synchronise at startup. Therefore, I needed to add a &ldquo;delay until Internet is connected before restarting NTP forwarder&rdquo; workaround into <code>/etc/rc.local</code> or in LuCI navigate to <code>System &gt; Startup</code>:</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># Wait until Internet connection is available</span>
<span style="color:#66d9ef">for</span> i in <span style="color:#f92672">{</span>1..60<span style="color:#f92672">}</span>; <span style="color:#66d9ef">do</span> ping -c1 8.8.8.8 &amp;&gt; /dev/null <span style="color:#f92672">&amp;&amp;</span> break; <span style="color:#66d9ef">done</span>

<span style="color:#75715e"># Restart time server just to be sure time gets updated</span>
/etc/init.d/sysntpd restart

<span style="color:#75715e"># Give enough time to synchronise with time server</span>
sleep <span style="color:#ae81ff">5</span>
</code></pre></div><p>On startup, the router will ping Google DNS, up to 60 tries or, until the first response is received whichever comes first. This delay workaround is very handy. I use it for other purposes too which I will blog about soon. Never let it try infinite number of times! Go figure why.</p><h3 id="testing">Testing</h3><p>I used a freeware tool called <a href="http://www.softpedia.com/get/Network-Tools/Network-Information/NTP-Tool.shtml">NTP Tool</a> downloaded from Softpedia.</p><p><a href="/images/2016/01/ntp-tool.png"><img src="/images/2016/01/ntp-tool.png" alt="Time Synchronization - System"></a></p><p>To verify, enter any valid host name that resolves. You should always get a response even if the host that you are trying to query does not have NTP server running on it, until/unless you are blocked for querying Google time servers too many times over a short time span.</p><h2 id="tips">Tips</h2><h3 id="dns-leaks-on-time-servers-lookup">DNS leaks on time servers lookup</h3><p>While NTP outbound traffic has been diverted to another server, the devices on your local network will still be sending DNS lookups to resolve the time servers that have been hardcoded in them.</p><p>To remove these leaks, we need to add some entries into <code>/etc/dnsmasq.conf</code> with example as below:</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">cname=time.nist.gov,openwrt.lan
cname=time-a.nist.gov,openwrt.lan
cname=time-b.nist.gov,openwrt.lan
cname=time-nw.nist.gov,openwrt.lan
cname=pool.ntp.org,openwrt.lan
cname=android.pool.ntp.org,openwrt.lan
</code></pre></div><p>Be sure to have <code>openwrt.lan</code> in <code>/etc/hosts</code> file:</p><div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-text" data-lang="text">192.168.1.1 openwrt.lan
</code></pre></div><h3 id="how-to-discover-the-time-server-domains-used-by-local-network-devices">How to discover the time server domains used by local network devices</h3><p>In my case, I use OpenDNS which provides a dashboard where I can see top domain names that are sent to it for querying. Not surprising, time servers occupied majority of the top 10 slots.</p><p>If you have better ways, please share it in the comments below.</p><ul class="list-inline tags" style="margin-left:0"><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/google">Google</a></li><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/openwrt">OpenWRT</a></li></ul></div></div><div class="row"><div id="disqus_thread"></div><script>!function(){if("localhost"!=window.location.hostname){var e=document.createElement("script");e.type="text/javascript",e.async=!0;e.src="https://leowkahman.disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}}()</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div><div class="col-sm-4 blog-sidebar"><div class="sidebar-module"><script>!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx=partner-pub-8585963436723502:5716828028";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><gcse:search></gcse:search></div><div class="sidebar-module"><h4>Recent Posts</h4><ul class="list-unstyled posts-recent"><li><a href="https://www.leowkahman.com/2020/02/01/speedtest-openwrt-with-flow-offloading/">Speedtest OpenWRT with flow offloading</a></li><li><a href="https://www.leowkahman.com/2019/02/06/ultrawide-monitor-on-linux/">Ultrawide monitor on Linux</a></li><li><a href="https://www.leowkahman.com/2019/02/03/switched-from-ubuntu-to-linux-mint/">Switched from Ubuntu to Linux Mint</a></li><li><a href="https://www.leowkahman.com/2018/08/11/reduce-internet-lag-on-openwrt/">Reduce internet lag on OpenWRT</a></li><li><a href="https://www.leowkahman.com/2018/05/29/workaround-to-wifi-issues-on-openwrt-lede/">Workaround to Wi-Fi issues on OpenWRT LEDE</a></li></ul></div><div class="sidebar-module"><h4>Categories</h4><ul class="list-unstyled posts-recent"><li><a href="https://www.leowkahman.com/categories/software/">software</a></li><li><a href="https://www.leowkahman.com/categories/web/">web</a></li><li><a href="https://www.leowkahman.com/categories/network/">network</a></li><li><a href="https://www.leowkahman.com/categories/hardware/">hardware</a></li><li><a href="https://www.leowkahman.com/categories/programming/">programming</a></li></ul></div></div></div></div><footer class="blog-footer"><div class="container"><div class="row"><div class="col-sm-8 col-xs-6"><ul class="list-inline links"><li><a href="/privacy-policy/">Privacy Policy</a></li></ul></div><div class="col-sm-4 col-xs-6"><ul class="list-inline"><li><a target="_blank" href="/index.xml"><i class="fa fa-rss fa-lg"></i></a></li><li><a target="_blank" href="https://stackexchange.com/users/6729082/leow-kah-man"><i class="fa fa-stack-exchange fa-lg"></i></a></li><li><a target="_blank" href="https://github.com/kmleow"><i class="fa fa-github fa-lg"></i></a></li><li><a target="_blank" href="https://twitter.com/kmleow"><i class="fa fa-twitter fa-lg"></i></a></li><li><a target="_blank" href="https://www.linkedin.com/in/kmleow"><i class="fa fa-linkedin fa-lg"></i></a></li><li><a target="_blank" href="https://www.facebook.com/LeowKahMan"><i class="fa fa-facebook fa-lg"></i></a></li><li><a target="_blank" href="https://www.paypal.me/leowkahman/5usd"><i class="fa fa-paypal fa-lg"></i></a></li></ul></div></div></div><div class="container"><div class="col-sm-12 row"><p>Except as otherwise noted, the content of this page is licensed under the <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>,<br/>code samples are licensed under the <a href="https://tldrlegal.com/license/mit-license">MIT License</a>. Third-party product names and logos may be the trademarks of their respective owners.</p></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/js/all.min.js" integrity="sha256-MAgcygDRahs+F/Nk5Vz387whB4kSK9NXlDN3w58LLq0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js" integrity="sha256-eOgo0OtLL4cdq7RdwRUiGKLX9XsIJ7nGhWEKbohmVAQ=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha256-Daf8GuI2eLKHJlOWLRR/zRy9Clqcj4TUSumbxYH9kGI=" crossorigin="anonymous"></script><script src="/js/custom.js?v=1.0.1"></script><script data-ad-client="ca-pub-8585963436723502" async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script async src="https://www.googletagmanager.com/gtag/js?id=UA-61838818-1"></script><script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","UA-61838818-1")</script></body></html>