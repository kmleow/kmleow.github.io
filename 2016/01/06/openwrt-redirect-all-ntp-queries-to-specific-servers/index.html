<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta http-equiv="Content-Security-Policy" content="default-src 'self' https:; script-src 'self' 'unsafe-eval' 'unsafe-inline' data: https:; img-src 'self' data: https:; style-src 'self' 'unsafe-inline' https:; font-src 'self' https:; object-src 'self'"/><meta name="viewport" content="width=device-width,initial-scale=1"><title>OpenWRT redirect all NTP queries to specific servers</title><meta name="msvalidate.01" content="009F12474AB330989749B979B5868A7F"/><meta name="google-site-verification" content="in8GfCIv-CYlwD5AxO0jVMlrUy1s42a_-cxlOWdv4U0"/><meta name="yandex-verification" content="c29e9c1084b24e1d"/><meta name="description" content="Most devices allow you to set the Network Time Protocol (NTP) server to one that you prefer but there are some devices that have hardcoded NTP server hostname"/><meta name="author" content="Leow Kah Man"/><link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192"/><link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32"/><link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16"/><link rel="canonical" href="https://www.leowkahman.com/2016/01/06/openwrt-redirect-all-ntp-queries-to-specific-servers/"><link href="" rel="alternate" type="application/rss+xml" title="Leow Kah Man - Tech Blog"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" integrity="sha256-Zd1icfZ72UBmsId/mUcagrmN7IN5Qkrvh75ICHIQVTk=" crossorigin="anonymous"/><link rel="stylesheet" href="/css/custom.css"/><style id="antiClickjack">body{display:none!important}</style><script>if(self===top){var antiClickjack=document.getElementById("antiClickjack");antiClickjack.parentNode.removeChild(antiClickjack)}else top.location=self.location</script><script>function redirectToCorrectDomainIfRequired(){for(var o=["www.leowkahman.com","localhost"],e=0;e<o.length;e++)if(window.location.hostname==o[e])return;window.location="https://www.leowkahman.com"+window.location.pathname}redirectToCorrectDomainIfRequired()</script></head><body><nav class="navbar navbar-default navbar-static-top"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">Leow Kah Man - Tech Blog</a></div><div id="navbar" class="navbar-collapse collapse"><ul class="nav navbar-nav"></ul><ul class="nav navbar-nav navbar-right"><li><a href="/about/">About</a></li><li><a href="/contact/">Contact</a></li></ul></div></div></nav><div class="container"><div class="row"><div class="col-sm-12"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="7600784826" data-ad-format="auto"></ins></div></div><div class="row"><div class="col-sm-8 blog-main"><div class="row"><div class="blog-main blog-post"><h1 class="blog-post-title">OpenWRT redirect all NTP queries to specific servers</h1><p class="blog-post-meta"><i class="fa fa-calendar"></i> Last updated on 2 April 2017 &nbsp; <i class="fa fa-folder"></i> <a href="https://www.leowkahman.com/categories/network">Network</a></p><ul class="list-inline share" style="margin-top:15px;margin-left:0"><li class="facebook-share"><a target="_blank" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.leowkahman.com%2f2016%2f01%2f06%2fopenwrt-redirect-all-ntp-queries-to-specific-servers%2f"><i class="fa fa-facebook fa-lg"></i> Facebook</a></li><li class="googleplus-share"><a target="_blank" href="https://plus.google.com/share?url=https%3a%2f%2fwww.leowkahman.com%2f2016%2f01%2f06%2fopenwrt-redirect-all-ntp-queries-to-specific-servers%2f"><i class="fa fa-google-plus fa-lg"></i> Google+</a></li><li class="twitter-share"><a target="_blank" href="https://twitter.com/share?url=https%3a%2f%2fwww.leowkahman.com%2f2016%2f01%2f06%2fopenwrt-redirect-all-ntp-queries-to-specific-servers%2f&amp;text=OpenWRT%20redirect%20all%20NTP%20queries%20to%20specific%20servers"><i class="fa fa-twitter fa-lg"></i> Twitter</a></li><li class="reddit-share"><a target="_blank" href="http://reddit.com/submit?url=https%3a%2f%2fwww.leowkahman.com%2f2016%2f01%2f06%2fopenwrt-redirect-all-ntp-queries-to-specific-servers%2f&amp;title=OpenWRT%20redirect%20all%20NTP%20queries%20to%20specific%20servers"><i class="fa fa-reddit fa-lg"></i> Reddit</a></li><li class="linkedin-share"><a target="_blank" href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.leowkahman.com%2f2016%2f01%2f06%2fopenwrt-redirect-all-ntp-queries-to-specific-servers%2f"><i class="fa fa-linkedin fa-lg"></i> LinkedIn</a></li></ul><p>Most devices allow you to set the <a href="https://en.wikipedia.org/wiki/Network_Time_Protocol">Network Time Protocol (NTP)</a> server to one that you prefer but there are some devices that have hardcoded NTP server hostname. This is mostly fine if all devices in your local network are synchronised to the same second but this is not always true. I have seen NTP servers that drift over 30 seconds. Not good&hellip;</p><p></p><h2 id="not-good-because">Not good because</h2><ol><li>You need all IP cameras to be in the correct time so that it is easier for you to piece evidence together from multiple cameras at specific time of an incident.</li><li>You need reliable NTP servers for which the manufacturer&rsquo;s hardcoded option is not.</li><li>IMHO, the most important reason is file synchronisation; so that every computer can agree on which copy of a file is the latest.</li></ol><h2 id="redirecting-ntp-requests-to-specific-server">Redirecting NTP requests to specific server</h2><p>Some manufacturers have hardcoded NTP servers in their NTP client. We could redirect all NTP requests to specific server or servers at router level. The solution I am sharing is specific to OpenWRT Chaos Calmer.</p><p>Note: This is not an Enterprise solution. This tutorial is ideal for home users only.</p><h3 id="defining-one-or-more-ntp-servers-to-use">Defining one or more NTP servers to use</h3><p>Check <strong>Enable NTP client</strong> and <strong>Provide NTP server</strong>. This is to configure the router to act as a NTP forwarder.</p><p>Pick your servers; <a href="http://www.pool.ntp.org/">pool.ntp.org</a> is a popular option but Malaysia seems to have (at time of writing) just one NTP server in the pool. This is fine if it is always working, unfortunately not. Therefore, I prefer Google Time Servers:</p><ul><li><code>time1.google.com</code></li><li><code>time2.google.com</code></li><li><code>time3.google.com</code></li><li><code>time4.google.com</code></li></ul><p>A small caveat: Google applies time smears for which you may like or dislike. You can read about it on their official <a href="https://googleblog.blogspot.com/2011/09/time-technology-and-leaping-seconds.html">blog article</a>.</p><p><img src="/images/2016/01/time-synchronization-system.png" alt="Time Synchronization - Syste"/></p><h3 id="redirect-all-ntp-queries-to-servers-defined">Redirect all NTP queries to servers defined</h3><p>Add a few lines into <code>Network &gt; Firewall &gt; Custom Rules</code> to redirect all NTP requests to the router&rsquo;s NTP forwarder regardless of the intended host name that your devices wish to connect to.</p><pre><code class="language-bash"># Redirect NTP requests to go through router
iptables -t nat -A PREROUTING -i br-lan -p udp --dport 123 -j REDIRECT --to-port 123
iptables -t nat -A PREROUTING -i br-guest -p udp --dport 123 -j REDIRECT --to-port 123
</code></pre><p>You may need to replace <code>br-lan</code> and <code>br-guest</code> if required. The former is my LAN network interface and the latter is my guest Wi-Fi network interface. Find yours under <code>Network &gt; Interfaces</code>.</p><h3 id="ensuring-time-is-up-to-date-as-soon-as-connection-is-available">Ensuring time is up-to-date as soon as connection is available</h3><p>When my router starts up, it takes random length of time to get connected to the Internet although usually under 30 seconds. Still, this delay sometimes causes my router&rsquo;s time not to synchronise at startup. Therefore, I needed to add a &ldquo;delay until Internet is connected before restarting NTP forwarder&rdquo; workaround into <code>/etc/rc.local</code> or in LuCI navigate to <code>System &gt; Startup</code>:</p><pre><code class="language-bash"># Wait until Internet connection is available
for i in {1..60}; do ping -c1 8.8.8.8 &amp;&gt; /dev/null &amp;&amp; break; done

# Restart time server just to be sure time gets updated
/etc/init.d/sysntpd restart

# Give enough time to synchronise with time server
sleep 5
</code></pre><p>On startup, the router will ping Google DNS, up to 60 tries or, until the first response is received whichever comes first. This delay workaround is very handy. I use it for other purposes too which I will blog about soon. Never let it try infinite number of times! Go figure why.</p><h3 id="testing">Testing</h3><p>I used a freeware tool called <a href="http://www.softpedia.com/get/Network-Tools/Network-Information/NTP-Tool.shtml">NTP Tool</a> downloaded from Softpedia.</p><p><img src="/images/2016/01/ntp-tool.png" alt="Time Synchronization - System"/></p><p>To verify, enter any valid host name that resolves. You should always get a response even if the host that you are trying to query does not have NTP server running on it, until/unless you are blocked for querying Google time servers too many times over a short time span.</p><ul class="list-inline tags" style="margin-left:0"><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/google">Google</a></li><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/openwrt">OpenWRT</a></li></ul></div></div><div class="blog-post"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="8937917223" data-ad-format="auto"></ins></div><div class="row"><div class="blog-post"><div id="disqus_thread"></div><script>!function(){if("localhost"!=window.location.hostname){var e=document.createElement("script");e.type="text/javascript",e.async=!0;e.src="https://leowkahman.disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}else document.write("Disqus comments are unavailable while serving on localhost or 127.0.0.1")}()</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div></div><div class="col-sm-4 blog-sidebar"><div class="sidebar-module"><script>!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx=partner-pub-8585963436723502:5716828028";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><gcse:search></gcse:search></div><div class="sidebar-module"><h4>Recent Posts</h4><ul class="list-unstyled posts-recent"><li><a href="https://www.leowkahman.com/2017/09/11/enforce-safe-search-on-google-youtube-bing/">Enforce Safe Search on Google, YouTube, Bing</a></li><li><a href="https://www.leowkahman.com/2017/09/10/gitlab-ci-remove-priority-zero-from-hugo-sitemap/">GitLab CI remove priority zero from Hugo sitemap</a></li><li><a href="https://www.leowkahman.com/2017/09/09/gitlab-ci-push-output-to-github/">GitLab CI push output to GitHub</a></li><li><a href="https://www.leowkahman.com/2017/09/05/tm-streamyx-router-wifi-security/">TM Streamyx Router Wi-Fi Security</a></li><li><a href="https://www.leowkahman.com/2017/08/15/hugo-static-site-generator-with-ci-deployment-using-gitlab/">Hugo Static Site Generator with CI Deployment using GitLab</a></li></ul></div><div class="sidebar-module"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="6069940020" data-ad-format="auto"></ins></div><div class="sidebar-module"><h4>Categories</h4><ul class="list-unstyled posts-recent"><li><a href="https://www.leowkahman.com/categories/web/">web</a></li><li><a href="https://www.leowkahman.com/categories/network/">network</a></li><li><a href="https://www.leowkahman.com/categories/software/">software</a></li><li><a href="https://www.leowkahman.com/categories/hardware/">hardware</a></li><li><a href="https://www.leowkahman.com/categories/cloud/">cloud</a></li></ul></div></div></div></div><footer class="blog-footer"><div class="container"><div class="row"><div class="col-sm-8 col-xs-6"><ul class="list-inline links"><li><a href="https://status.leowkahman.com/">Uptime</a></li></ul></div><div class="col-sm-4 col-xs-6"><ul class="list-inline"><li><a target="_blank" href="/index.xml"><i class="fa fa-rss fa-lg"></i></a></li><li><a target="_blank" href="https://stackexchange.com/users/6729082/leow-kah-man"><i class="fa fa-stack-exchange fa-lg"></i></a></li><li><a target="_blank" href="https://github.com/kmleow"><i class="fa fa-github fa-lg"></i></a></li><li><a target="_blank" href="https://www.linkedin.com/in/kmleow"><i class="fa fa-linkedin fa-lg"></i></a></li><li><a target="_blank" href="https://www.facebook.com/LeowKahMan"><i class="fa fa-facebook fa-lg"></i></a></li></ul></div></div></div><div class="container"><div class="col-sm-12 row"><p>Except as otherwise noted, the content of this page is licensed under the <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License </a>,<br/>code samples are licensed under the <a href="https://tldrlegal.com/license/mit-license">MIT License</a>.</p></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script><script>hljs.initHighlightingOnLoad()</script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>"localhost"==window.location.hostname?($(".adsbygoogle").css("text-decoration","none"),$(".adsbygoogle").text("Adsense is unavailable while serving on localhost or 127.0.0.1")):[].forEach.call(document.querySelectorAll(".adsbygoogle"),function(){(adsbygoogle=window.adsbygoogle||[]).push({})})</script><script>!function(e,a,t,n,c,o,s){e.GoogleAnalyticsObject=c,e[c]=e[c]||function(){(e[c].q=e[c].q||[]).push(arguments)},e[c].l=1*new Date,o=a.createElement(t),s=a.getElementsByTagName(t)[0],o.async=1,o.src="//www.google-analytics.com/analytics.js",s.parentNode.insertBefore(o,s)}(window,document,"script",0,"ga"),ga("create","UA-61838818-1","auto"),ga("send","pageview"),ga("set","forceSSL",!0)</script></body></html>