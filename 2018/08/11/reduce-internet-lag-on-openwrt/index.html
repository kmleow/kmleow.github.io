<!DOCTYPE html><html lang="en-us"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Reduce internet lag on OpenWRT</title><meta name="msvalidate.01" content="009F12474AB330989749B979B5868A7F"/><meta name="google-site-verification" content="in8GfCIv-CYlwD5AxO0jVMlrUy1s42a_-cxlOWdv4U0"/><meta name="yandex-verification" content="c29e9c1084b24e1d"/><meta name="description" content="How to reduce internet lag on OpenWRT when there is heavy download/upload activity on the same internet connection."/><meta name="author" content="Leow Kah Man"/><link rel="icon" type="image/png" href="/favicon-192x192.png" sizes="192x192"/><link rel="icon" type="image/png" href="/favicon-32x32.png" sizes="32x32"/><link rel="icon" type="image/png" href="/favicon-16x16.png" sizes="16x16"/><link rel="canonical" href="https://www.leowkahman.com/2018/08/11/reduce-internet-lag-on-openwrt/"><link href="" rel="alternate" type="application/rss+xml" title="Leow Kah Man - Tech Blog"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous"/><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css" integrity="sha256-Zd1icfZ72UBmsId/mUcagrmN7IN5Qkrvh75ICHIQVTk=" crossorigin="anonymous"/><link rel="stylesheet" href="/css/custom.css?v=1.0.0"/><style id="antiClickjack">body{display:none!important}</style><script>if(self===top){var antiClickjack=document.getElementById("antiClickjack");antiClickjack.parentNode.removeChild(antiClickjack)}else top.location=self.location</script><script>function redirectToCorrectDomainIfRequired(){for(var o=["www.leowkahman.com","localhost"],e=0;e<o.length;e++)if(window.location.hostname==o[e])return;window.location="https://www.leowkahman.com"+window.location.pathname}redirectToCorrectDomainIfRequired()</script></head><body><nav class="navbar navbar-default navbar-static-top"><div class="container"><div class="navbar-header"><button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"><span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span></button> <a class="navbar-brand" href="/">Leow Kah Man - Tech Blog</a></div><div id="navbar" class="navbar-collapse collapse"><ul class="nav navbar-nav"></ul><ul class="nav navbar-nav navbar-right"><li><a href="/about/">About</a></li><li><a href="/contact/">Contact</a></li></ul></div></div></nav><div class="container"><div class="row"><div class="col-sm-12"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="7600784826" data-ad-format="auto"></ins></div></div><div class="row"><div class="col-sm-8 blog-main"><div class="row"><div class="blog-main blog-post"><h1 class="blog-post-title">Reduce internet lag on OpenWRT</h1><p class="blog-post-meta"><i class="fa fa-calendar"></i> Published: 11 August 2018 &nbsp;|&nbsp; <i class="fa fa-folder"></i> <a href="https://www.leowkahman.com/categories/software">Software</a></p><ul class="list-inline share" style="margin-top:15px;margin-left:0"><li class="facebook-share"><a target="_blank" href="http://www.facebook.com/sharer.php?u=https%3a%2f%2fwww.leowkahman.com%2f2018%2f08%2f11%2freduce-internet-lag-on-openwrt%2f"><i class="fa fa-facebook fa-lg"></i> Facebook</a></li><li class="googleplus-share"><a target="_blank" href="https://plus.google.com/share?url=https%3a%2f%2fwww.leowkahman.com%2f2018%2f08%2f11%2freduce-internet-lag-on-openwrt%2f"><i class="fa fa-google-plus fa-lg"></i> Google+</a></li><li class="twitter-share"><a target="_blank" href="https://twitter.com/share?url=https%3a%2f%2fwww.leowkahman.com%2f2018%2f08%2f11%2freduce-internet-lag-on-openwrt%2f&amp;text=Reduce%20internet%20lag%20on%20OpenWRT"><i class="fa fa-twitter fa-lg"></i> Twitter</a></li><li class="reddit-share"><a target="_blank" href="http://reddit.com/submit?url=https%3a%2f%2fwww.leowkahman.com%2f2018%2f08%2f11%2freduce-internet-lag-on-openwrt%2f&amp;title=Reduce%20internet%20lag%20on%20OpenWRT"><i class="fa fa-reddit fa-lg"></i> Reddit</a></li><li class="linkedin-share"><a target="_blank" href="http://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.leowkahman.com%2f2018%2f08%2f11%2freduce-internet-lag-on-openwrt%2f"><i class="fa fa-linkedin fa-lg"></i> LinkedIn</a></li></ul><p>How to reduce internet lag on OpenWRT when there is heavy download/upload activity on the same internet connection.</p><p></p><h2 id="motivation">Motivation</h2><p>When there is heavy download/upload activity going on in my home network, latency spikes. This effect is felt when playing real-time online games where latency could cause a very unpleasant lag experience.</p><p>For example, I ran a continuous <code>ping</code> against Google DNS and then started <a href="https://www.speedtest.net">Speedtest</a>. Take a look at the spike in latency. This is on a 100Mbps/50Mbps download/upload link:</p><pre><code class="language-text">64 bytes from 8.8.8.8: seq=10 ttl=124 time=3.321 ms
64 bytes from 8.8.8.8: seq=11 ttl=124 time=3.488 ms
64 bytes from 8.8.8.8: seq=12 ttl=124 time=3.539 ms
64 bytes from 8.8.8.8: seq=13 ttl=124 time=24.593 ms
64 bytes from 8.8.8.8: seq=14 ttl=124 time=21.562 ms
64 bytes from 8.8.8.8: seq=15 ttl=124 time=50.528 ms
64 bytes from 8.8.8.8: seq=16 ttl=124 time=50.492 ms
64 bytes from 8.8.8.8: seq=17 ttl=124 time=48.279 ms
64 bytes from 8.8.8.8: seq=18 ttl=124 time=42.630 ms
64 bytes from 8.8.8.8: seq=19 ttl=124 time=53.913 ms
64 bytes from 8.8.8.8: seq=20 ttl=124 time=40.759 ms
64 bytes from 8.8.8.8: seq=21 ttl=124 time=29.398 ms
64 bytes from 8.8.8.8: seq=22 ttl=124 time=17.992 ms
64 bytes from 8.8.8.8: seq=23 ttl=124 time=23.571 ms
64 bytes from 8.8.8.8: seq=24 ttl=124 time=5.479 ms
64 bytes from 8.8.8.8: seq=25 ttl=124 time=5.117 ms
</code></pre><p>There is an easy way to resolve this without needing to stop downloads/uploads.</p><h2 id="solution">Solution</h2><h3 id="overview">Overview</h3><p>I installed <a href="https://openwrt.org/docs/guide-user/network/traffic-shaping/sqm">Smart Queue Management (SQM)</a>. With minimal configuration, <code>ping</code> times spiked to no more than 11 seconds while running speed test.</p><h3 id="measure-current-speed">Measure current speed</h3><p>Before tweaking settings, obtain a baseline top download/upload speed via speed test.</p><h3 id="setup">Setup</h3><p>Install SQM packages:</p><pre><code class="language-bash">opkg update
opkg install sqm-scripts luci-app-sqm
</code></pre><p>A new menu item should appear under <code>Network</code> called <code>SQM QoS</code>.</p><p>Check the <strong>Enable</strong> box.</p><p>Select your WAN interface, in my case it is named <code>pppoe-wan</code>.</p><p>For <strong>Queue Discipline</strong>, select <code>cake</code> and use <code>piece_of_cake.qos</code> queue setup script.</p><p>For <strong>Link Layer Adaptation</strong>, the <a href="https://openwrt.org/docs/guide-user/network/traffic-shaping/sqm">SQM guide on OpenWRT</a> suggests the following (as at 2018-08-11):</p><blockquote><ul><li>For VDSL - Choose Ethernet, and set per packet overhead to 8</li><li>For DSL of any other type - Choose ATM, and set per packet overhead to 44</li><li>For Cable or other kinds of connections - Choose Ethernet, and set per packet overhead to 18</li></ul></blockquote><p>The download and upload speeds should be set to a figure between 80 and 95 percent of the maximum speed from the baseline obtained. Tweak the settings then conduct a speed test while running <code>ping</code> continuously to determine the maximum spike in latency until an reaching an acceptable threshold (determined by you). In my case, it is set to 90 percent. As you have figured, the trade-off is that top speed has now reduced.</p><h3 id="results">Results</h3><p>Here are the <code>ping</code> results with SQM enabled while running speed test:</p><pre><code class="language-text">64 bytes from 8.8.8.8: seq=11 ttl=124 time=3.504 ms
64 bytes from 8.8.8.8: seq=12 ttl=124 time=3.784 ms
64 bytes from 8.8.8.8: seq=13 ttl=124 time=8.375 ms
64 bytes from 8.8.8.8: seq=14 ttl=124 time=5.295 ms
64 bytes from 8.8.8.8: seq=15 ttl=124 time=9.399 ms
64 bytes from 8.8.8.8: seq=16 ttl=124 time=11.281 ms
64 bytes from 8.8.8.8: seq=17 ttl=124 time=8.722 ms
64 bytes from 8.8.8.8: seq=18 ttl=124 time=10.971 ms
64 bytes from 8.8.8.8: seq=19 ttl=124 time=5.967 ms
64 bytes from 8.8.8.8: seq=20 ttl=124 time=7.454 ms
64 bytes from 8.8.8.8: seq=21 ttl=124 time=8.961 ms
64 bytes from 8.8.8.8: seq=22 ttl=124 time=11.533 ms
64 bytes from 8.8.8.8: seq=23 ttl=124 time=5.365 ms
64 bytes from 8.8.8.8: seq=24 ttl=124 time=10.102 ms
64 bytes from 8.8.8.8: seq=25 ttl=124 time=10.312 ms
64 bytes from 8.8.8.8: seq=26 ttl=124 time=6.405 ms
64 bytes from 8.8.8.8: seq=27 ttl=124 time=6.356 ms
64 bytes from 8.8.8.8: seq=28 ttl=124 time=4.418 ms
64 bytes from 8.8.8.8: seq=29 ttl=124 time=4.547 ms
</code></pre><p>No more <a href="https://www.urbandictionary.com/define.php?term=Death%20Lag">death lags</a>.</p><ul class="list-inline tags" style="margin-left:0"><li class="btn btn-primary"><a href="https://www.leowkahman.com/tags/openwrt">openwrt</a></li></ul></div></div><div class="blog-post"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="8937917223" data-ad-format="auto"></ins></div><div class="row"><div id="disqus_thread"></div><script>!function(){if("localhost"!=window.location.hostname){var e=document.createElement("script");e.type="text/javascript",e.async=!0;e.src="https://leowkahman.disqus.com/embed.js",(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(e)}}()</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript></div></div><div class="col-sm-4 blog-sidebar"><div class="sidebar-module"><script>!function(){var e=document.createElement("script");e.type="text/javascript",e.async=!0,e.src="https://cse.google.com/cse.js?cx=partner-pub-8585963436723502:5716828028";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><gcse:search></gcse:search></div><div class="sidebar-module"><h4>Recent Posts</h4><ul class="list-unstyled posts-recent"><li><a href="https://www.leowkahman.com/2018/08/11/reduce-internet-lag-on-openwrt/">Reduce internet lag on OpenWRT</a></li><li><a href="https://www.leowkahman.com/2018/05/29/workaround-to-wifi-issues-on-openwrt-lede/">Workaround to Wi-Fi issues on OpenWRT LEDE</a></li><li><a href="https://www.leowkahman.com/2018/04/23/writing-readable-linq-code-in-csharp/">Writing readable LINQ code in C#</a></li><li><a href="https://www.leowkahman.com/2018/04/13/solution-to-images-not-showing-on-inoreader/">Solution to images not showing on InoReader</a></li><li><a href="https://www.leowkahman.com/2018/04/08/prevent-overheating-by-disabling-turbo-boost/">Prevent overheating by disabling turbo boost</a></li></ul></div><div class="sidebar-module"><ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-8585963436723502" data-ad-slot="6069940020" data-ad-format="auto"></ins></div><div class="sidebar-module"><h4>Categories</h4><ul class="list-unstyled posts-recent"><li><a href="https://www.leowkahman.com/categories/software/">software</a></li><li><a href="https://www.leowkahman.com/categories/web/">web</a></li><li><a href="https://www.leowkahman.com/categories/network/">network</a></li><li><a href="https://www.leowkahman.com/categories/hardware/">hardware</a></li><li><a href="https://www.leowkahman.com/categories/cloud/">cloud</a></li></ul></div></div></div></div><footer class="blog-footer"><div class="container"><div class="row"><div class="col-sm-8 col-xs-6"><ul class="list-inline links"><li><a href="/privacy-policy/">Privacy Policy</a></li><li><a href="https://status.leowkahman.com/">Uptime</a></li></ul></div><div class="col-sm-4 col-xs-6"><ul class="list-inline"><li><a target="_blank" href="/index.xml"><i class="fa fa-rss fa-lg"></i></a></li><li><a target="_blank" href="https://stackexchange.com/users/6729082/leow-kah-man"><i class="fa fa-stack-exchange fa-lg"></i></a></li><li><a target="_blank" href="https://github.com/kmleow"><i class="fa fa-github fa-lg"></i></a></li><li><a target="_blank" href="https://twitter.com/kmleow"><i class="fa fa-twitter fa-lg"></i></a></li><li><a target="_blank" href="https://www.linkedin.com/in/kmleow"><i class="fa fa-linkedin fa-lg"></i></a></li><li><a target="_blank" href="https://www.facebook.com/LeowKahMan"><i class="fa fa-facebook fa-lg"></i></a></li><li><a target="_blank" href="https://www.paypal.me/leowkahman/5usd"><i class="fa fa-paypal fa-lg"></i></a></li></ul></div></div></div><div class="container"><div class="col-sm-12 row"><p>Except as otherwise noted, the content of this page is licensed under the <a rel="license" href="https://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>,<br/>code samples are licensed under the <a href="https://tldrlegal.com/license/mit-license">MIT License</a>. Third-party product names and logos may be the trademarks of their respective owners.</p></div></div></footer><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/1.12.4/jquery.min.js" integrity="sha256-ZosEbRLbNQzLpnKIkEdrPv7lOy9C27hHQ+Xp8a4MxAQ=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js" integrity="sha256-/BfiIkHlHoVihZdc6TFuj7MmJ0TWcWsMXkeDFwhi0zw=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha256-Daf8GuI2eLKHJlOWLRR/zRy9Clqcj4TUSumbxYH9kGI=" crossorigin="anonymous"></script><script src="/js/custom.js?v=1.0.1"></script><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>[].forEach.call(document.querySelectorAll(".adsbygoogle"),function(){(adsbygoogle=window.adsbygoogle||[]).push({})})</script><script>!function(e,a,t,n,g,c,o){e.GoogleAnalyticsObject=g,e.ga=e.ga||function(){(e.ga.q=e.ga.q||[]).push(arguments)},e.ga.l=1*new Date,c=a.createElement(t),o=a.getElementsByTagName(t)[0],c.async=1,c.src="//www.google-analytics.com/analytics.js",o.parentNode.insertBefore(c,o)}(window,document,"script",0,"ga"),ga("create","UA-61838818-1","auto"),ga("send","pageview"),ga("set","forceSSL",!0)</script></body></html>